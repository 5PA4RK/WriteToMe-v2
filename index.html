<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WriteToMe - Secure Chat</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --dark-bg: #2a2a2a;
            --darker-bg: #333333;
            --card-bg: #3a3a3a;
            --border-color: #555;
            --text-primary: #f8f8f8;
            --text-secondary: #dddddd;
            --accent-orange: #ff9800;
            --accent-orange-dark: #e68900;
            --success-green: #4caf50;
            --danger-red: #f44336;
            --warning-yellow: #ffc107;
            --info-blue: #2196f3;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--dark-bg);
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            width: 100%;
        }

        header {
            background-color: var(--darker-bg);
            padding: 15px 20px;
            border-bottom: 2px solid var(--accent-orange);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo i {
            color: var(--accent-orange);
            font-size: 28px;
        }

        .logo h1 {
            font-size: 24px;
            color: var(--accent-orange);
            letter-spacing: 1px;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-status {
            display: flex;
            align-items: center;
            gap: 10px;
            background-color: var(--card-bg);
            padding: 8px 15px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: var(--success-green);
        }

        .status-indicator.offline {
            background-color: var(--danger-red);
        }

        .main-app {
            display: flex;
            gap: 25px;
            padding: 25px 0;
        }

        .chat-section {
            flex: 2;
            background-color: var(--card-bg);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            overflow: hidden;
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            height: 75vh;
        }

        .sessions-panel {
            flex: 1;
            background-color: var(--card-bg);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            overflow: hidden;
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            height: 75vh;
        }

        .section-header {
            background-color: var(--darker-bg);
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-header h2 {
            color: var(--accent-orange);
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chat-title {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }

        .history-indicator {
            background-color: var(--info-blue);
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }

        .active-chat-btn {
            background-color: var(--success-green);
            color: white;
            padding: 6px 15px;
            border-radius: 6px;
            font-size: 12px;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            text-decoration: none;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 12px;
            position: relative;
            line-height: 1.4;
            transition: all 0.2s;
        }

        .message:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }

        .message.sent {
            align-self: flex-end;
            background-color: var(--accent-orange);
            color: var(--darker-bg);
        }

        .message.received {
            align-self: flex-start;
            background-color: #555555;
            color: var(--text-primary);
        }

        .message.system {
            align-self: center;
            background-color: rgba(33, 150, 243, 0.2);
            color: var(--text-primary);
            max-width: 90%;
            text-align: center;
            border: 1px solid var(--info-blue);
        }

        .message-image {
            max-width: 300px;
            border-radius: 8px;
            margin-top: 8px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .message-image:hover {
            transform: scale(1.02);
        }

        .message-sender {
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 5px;
            color: var(--accent-orange-dark);
        }

        .message.sent .message-sender {
            color: #000;
        }

        .message-time {
            font-size: 11px;
            text-align: right;
            margin-top: 5px;
            opacity: 0.8;
        }

        .message-actions {
            position: absolute;
            top: 5px;
            right: 5px;
            display: none;
            gap: 5px;
        }

        .message:hover .message-actions {
            display: flex;
        }

        .message-action-btn {
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            border-radius: 4px;
            width: 24px;
            height: 24px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .message-action-btn:hover {
            background: rgba(0, 0, 0, 0.9);
        }

        .chat-input-area {
            padding: 15px 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .message-input-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .chat-input {
            width: 100%;
            padding: 12px 16px;
            background-color: var(--darker-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s;
            resize: none;
            min-height: 60px;
            max-height: 120px;
        }

        .chat-input:focus {
            border-color: var(--accent-orange);
        }

        .input-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .file-upload-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 20px;
            padding: 5px;
        }

        .file-upload-btn:hover {
            color: var(--accent-orange);
        }

        .btn {
            padding: 10px 20px;
            background-color: var(--accent-orange);
            color: var(--darker-bg);
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 14px;
        }

        .btn:hover {
            background-color: var(--accent-orange-dark);
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-danger {
            background-color: var(--danger-red);
            color: white;
        }

        .btn-danger:hover {
            background-color: #d32f2f;
        }

        .btn-success {
            background-color: var(--success-green);
            color: white;
        }

        .btn-info {
            background-color: var(--info-blue);
            color: white;
        }

        .btn-secondary {
            background-color: var(--border-color);
            color: var(--text-primary);
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 12px;
        }

        .sessions-list {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .session-card {
            background-color: #333333;
            border-radius: 8px;
            padding: 15px;
            border-left: 4px solid var(--border-color);
            transition: all 0.3s;
        }

        .session-card.active {
            border-left-color: var(--success-green);
            background-color: rgba(76, 175, 80, 0.1);
        }

        .session-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .session-status {
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: bold;
        }

        .status-active {
            background-color: var(--success-green);
            color: white;
        }

        .status-ended {
            background-color: var(--danger-red);
            color: white;
        }

        .session-details {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        .session-details p {
            margin: 3px 0;
        }

        .session-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .session-actions .btn {
            flex: 1;
            min-width: 70px;
        }

        .connection-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: var(--card-bg);
            width: 90%;
            max-width: 400px;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--accent-orange);
        }

        .modal-header {
            background-color: var(--darker-bg);
            padding: 15px 20px;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-header h2 {
            color: var(--accent-orange);
            font-size: 20px;
        }

        .modal-body {
            padding: 20px;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group label {
            color: var(--text-primary);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            background-color: var(--darker-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s;
        }

        .form-input:focus {
            border-color: var(--accent-orange);
        }

        .error-message {
            color: var(--danger-red);
            font-size: 13px;
            margin-top: 5px;
            display: none;
        }

        .password-hint {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px;
            font-style: italic;
        }

        footer {
            margin-top: auto;
            padding: 15px;
            text-align: center;
            color: var(--text-secondary);
            font-size: 13px;
            border-top: 1px solid var(--border-color);
        }

        .typing-indicator {
            padding: 10px 20px;
            font-style: italic;
            color: var(--accent-orange);
            display: none;
            font-size: 13px;
        }

        .typing-indicator.show {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .pending-guests {
            margin: 15px;
            padding: 15px;
            background-color: rgba(255, 152, 0, 0.1);
            border-radius: 8px;
            border: 1px solid var(--accent-orange);
        }

        .guest-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background-color: var(--darker-bg);
            border-radius: 6px;
            margin: 5px 0;
        }

        .guest-actions {
            display: flex;
            gap: 8px;
        }

        .guest-list {
            max-height: 150px;
            overflow-y: auto;
            margin: 10px 0;
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--danger-red);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 11px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sound-toggle {
            position: relative;
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--darker-bg);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-orange);
        }

        /* Image preview modal */
        .image-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .image-modal img {
            max-width: 90%;
            max-height: 90%;
            border-radius: 8px;
        }

        .image-modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            color: white;
            font-size: 30px;
            cursor: pointer;
        }

        /* Reply preview */
        .reply-preview {
            background-color: rgba(255, 152, 0, 0.1);
            border-left: 3px solid var(--accent-orange);
            padding: 8px 12px;
            margin-bottom: 10px;
            border-radius: 6px;
            display: none;
        }

        .reply-preview .reply-sender {
            font-weight: bold;
            font-size: 12px;
            color: var(--accent-orange);
        }

        .reply-preview .reply-text {
            font-size: 13px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .cancel-reply {
            background: none;
            border: none;
            color: var(--danger-red);
            cursor: pointer;
            margin-left: 10px;
        }
        
        .debug-console {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.9);
            color: #0f0;
            font-family: monospace;
            font-size: 12px;
            padding: 10px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 9999;
            display: none;
        }
        
        .debug-toggle {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body>
    <!-- Connection Modal -->
    <div id="connectionModal" class="connection-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-user-shield"></i> WriteToMe - Secure Connection</h2>
            </div>
            <div class="modal-body">
                <div class="login-form">
                    <div class="form-group">
                        <label for="userSelect"><i class="fas fa-user"></i> Select Role:</label>
                        <select id="userSelect" class="form-input">
                            <option value="guest">Guest</option>
                            <option value="host">Host</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="passwordInput"><i class="fas fa-lock"></i> Password:</label>
                        <input type="password" id="passwordInput" class="form-input" placeholder="Enter password">
                        <div id="passwordHint" class="password-hint"></div>
                    </div>
                    
                    <div id="passwordError" class="error-message">
                        Incorrect password for selected role.
                    </div>
                    
                    <div id="connectionError" class="error-message" style="color: #ff9800; display: none;">
                        Connection error. Check console.
                    </div>
                    
                    <button id="connectBtn" class="btn" style="width: 100%;">
                        <i class="fas fa-plug"></i> Connect
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Image Preview Modal -->
    <div id="imageModal" class="image-modal">
        <span class="image-modal-close">&times;</span>
        <img id="modalImage" src="" alt="Preview">
    </div>

    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-comment-alt"></i>
                    <h1>WriteToMe</h1>
                </div>
                <div class="header-controls">
                    <div class="user-status">
                        <div id="statusIndicator" class="status-indicator offline"></div>
                        <span id="userRoleDisplay">Disconnected</span>
                    </div>
                    <div class="sound-toggle">
                        <button id="soundToggle" class="btn btn-secondary" style="padding: 8px 12px;">
                            <i class="fas fa-volume-up"></i>
                        </button>
                    </div>
                    <button id="logoutBtn" class="btn btn-secondary" style="display: none;">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="main-app">
            <!-- Chat Section -->
            <section class="chat-section">
                <div class="section-header">
                    <div class="chat-title">
                        <h2><i class="fas fa-comments"></i> <span id="chatTitle">Secure Chat</span></h2>
                        <span id="historyIndicator" class="history-indicator" style="display: none;">Historical Chat</span>
                    </div>
                    <a id="returnToActiveBtn" class="active-chat-btn" style="display: none;">
                        <i class="fas fa-arrow-left"></i> Return to Active Chat
                    </a>
                </div>
                
                <!-- Pending Guests Section (Host Only) -->
                <div id="pendingGuests" class="pending-guests" style="display: none;">
                    <h3><i class="fas fa-user-clock"></i> Pending Guests</h3>
                    <div id="guestList" class="guest-list"></div>
                </div>
                
                <!-- Reply Preview -->
                <div id="replyPreview" class="reply-preview">
                    <div class="reply-header">
                        <span class="reply-sender"></span>
                        <button class="cancel-reply"><i class="fas fa-times"></i></button>
                    </div>
                    <div class="reply-text"></div>
                </div>
                
                <div class="chat-messages" id="chatMessages">
                    <div class="message system">
                        <div>Welcome to WriteToMe! Connect to start chatting.</div>
                        <div class="message-time">Just now</div>
                    </div>
                </div>
                
                <div id="typingIndicator" class="typing-indicator">
                    <i class="fas fa-pencil-alt"></i> <span id="typingUser">User</span> is typing...
                </div>
                
                <div class="chat-input-area">
                    <div class="message-input-container">
                        <textarea 
                            id="messageInput" 
                            class="chat-input" 
                            placeholder="Type your message here... (Press Enter to send, Shift+Enter for new line)" 
                            disabled
                            rows="3"
                        ></textarea>
                        <div class="input-actions">
                            <input type="file" id="imageUpload" accept="image/*" style="display: none;">
                            <button id="attachImageBtn" class="file-upload-btn" disabled>
                                <i class="fas fa-image"></i>
                            </button>
                            <div style="flex: 1;"></div>
                            <span id="charCount" style="font-size: 12px; color: var(--text-secondary);">0/1000</span>
                        </div>
                    </div>
                    <button id="sendMessageBtn" class="btn" disabled>
                        <i class="fas fa-paper-plane"></i> Send
                    </button>
                </div>
            </section>

            <!-- Sessions Panel -->
            <section class="sessions-panel">
                <div class="section-header">
                    <h2><i class="fas fa-history"></i> Chat Sessions</h2>
                    <button id="refreshSessionsBtn" class="btn btn-small">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                <div class="sessions-list" id="sessionsList">
                    <!-- Sessions will be loaded here -->
                    <div class="session-card">
                        <div class="session-card-header">
                            <h4>No Active Sessions</h4>
                        </div>
                        <div class="session-details">
                            <p>Connect as host to see sessions</p>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <footer>
        <div class="container">
            <p>WriteToMe &copy; 2023 - Secure Communication Platform</p>
        </div>
    </footer>

    <!-- Debug Console -->
    <div id="debugConsole" class="debug-console"></div>
    <button id="debugToggle" class="debug-toggle">üîß</button>

    <!-- Audio for message notification -->
    <audio id="messageSound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-message-pop-alert-2354.mp3" type="audio/mpeg">
    </audio>

    <script>
        // ==================== DEBUG UTILITIES ====================
        function debugLog(message, data = null) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            console.log(logEntry, data || '');
            
            // Add to debug console
            const debugConsole = document.getElementById('debugConsole');
            if (debugConsole) {
                const line = document.createElement('div');
                line.textContent = logEntry;
                debugConsole.appendChild(line);
                debugConsole.scrollTop = debugConsole.scrollHeight;
            }
        }

        function showError(message) {
            debugLog(`‚ùå ERROR: ${message}`);
            alert(`Error: ${message}\n\nCheck debug console for details.`);
        }

        // ==================== SUPABASE CONFIG ====================
        const SUPABASE_URL = 'https://plqvqenoroacvzwtgoxq.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_91IHQ5--y4tDIo8L9X2ZJQ_YeThfdu_';
        
        debugLog('Initializing Supabase...');
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // ==================== APP STATE ====================
        const appState = {
            isHost: false,
            isConnected: false,
            userName: '',
            userId: null,
            sessionId: null,
            messages: [],
            soundEnabled: true,
            replyTo: null,
            editingMessage: null,
            viewingHistory: false
        };

        // ==================== DOM ELEMENTS ====================
        const connectionModal = document.getElementById('connectionModal');
        const userSelect = document.getElementById('userSelect');
        const passwordInput = document.getElementById('passwordInput');
        const passwordHint = document.getElementById('passwordHint');
        const connectBtn = document.getElementById('connectBtn');
        const passwordError = document.getElementById('passwordError');
        const connectionError = document.getElementById('connectionError');
        const logoutBtn = document.getElementById('logoutBtn');
        const statusIndicator = document.getElementById('statusIndicator');
        const userRoleDisplay = document.getElementById('userRoleDisplay');
        const soundToggle = document.getElementById('soundToggle');
        const chatMessages = document.getElementById('chatMessages');
        const chatTitle = document.getElementById('chatTitle');
        const historyIndicator = document.getElementById('historyIndicator');
        const returnToActiveBtn = document.getElementById('returnToActiveBtn');
        const messageInput = document.getElementById('messageInput');
        const sendMessageBtn = document.getElementById('sendMessageBtn');
        const attachImageBtn = document.getElementById('attachImageBtn');
        const imageUpload = document.getElementById('imageUpload');
        const charCount = document.getElementById('charCount');
        const pendingGuestsDiv = document.getElementById('pendingGuests');
        const guestList = document.getElementById('guestList');
        const sessionsList = document.getElementById('sessionsList');
        const refreshSessionsBtn = document.getElementById('refreshSessionsBtn');
        const replyPreview = document.getElementById('replyPreview');
        const messageSound = document.getElementById('messageSound');
        const debugConsole = document.getElementById('debugConsole');
        const debugToggle = document.getElementById('debugToggle');

        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', async function() {
            debugLog('üöÄ WriteToMe App Starting...');
            
            // Setup event listeners
            setupEventListeners();
            
            // Test database connection
            await testDatabaseConnection();
            
            // Check for saved session
            const savedSession = localStorage.getItem('writeToMe_session');
            if (savedSession) {
                try {
                    const sessionData = JSON.parse(savedSession);
                    debugLog('Found saved session', sessionData);
                    
                    appState.isHost = sessionData.isHost;
                    appState.userName = sessionData.userName;
                    appState.userId = sessionData.userId;
                    appState.sessionId = sessionData.sessionId;
                    
                    if (await verifySessionExists()) {
                        debugLog('‚úÖ Session verified, auto-logging in');
                        await completeLogin();
                    } else {
                        debugLog('‚ùå Session expired or not found');
                        localStorage.removeItem('writeToMe_session');
                        showConnectionModal();
                    }
                } catch (e) {
                    debugLog('Error loading saved session', e);
                    localStorage.removeItem('writeToMe_session');
                    showConnectionModal();
                }
            } else {
                showConnectionModal();
            }
            
            // Load sound preference
            appState.soundEnabled = localStorage.getItem('writeToMe_sound') !== 'false';
            updateSoundButton();
            
            debugLog('‚úÖ App initialization complete');
        });

        // ==================== EVENT LISTENERS ====================
        function setupEventListeners() {
            debugLog('Setting up event listeners...');
            
            // Password hint
            userSelect.addEventListener('change', function() {
                updatePasswordHint();
                passwordError.style.display = 'none';
                connectionError.style.display = 'none';
            });
            
            // Enter key in password field
            passwordInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    handleConnect();
                }
            });
            
            // Connect button
            connectBtn.addEventListener('click', handleConnect);
            
            // Logout
            logoutBtn.addEventListener('click', handleLogout);
            
            // Sound toggle
            soundToggle.addEventListener('click', toggleSound);
            
            // Chat input
            messageInput.addEventListener('input', updateCharCount);
            messageInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            // Send message
            sendMessageBtn.addEventListener('click', sendMessage);
            
            // Image upload
            attachImageBtn.addEventListener('click', function() {
                imageUpload.click();
            });
            
            imageUpload.addEventListener('change', handleImageUpload);
            
            // Sessions refresh
            refreshSessionsBtn.addEventListener('click', loadSessions);
            
            // Reply cancel
            replyPreview.querySelector('.cancel-reply').addEventListener('click', cancelReply);
            
            // Return to active chat
            returnToActiveBtn.addEventListener('click', returnToActiveChat);
            
            // Debug toggle
            debugToggle.addEventListener('click', function() {
                debugConsole.style.display = debugConsole.style.display === 'none' ? 'block' : 'none';
            });
            
            // Initialize password hint
            updatePasswordHint();
        }

        function updatePasswordHint() {
            if (userSelect.value === 'host') {
                passwordHint.textContent = 'Host password: Mira4994Mira';
            } else {
                passwordHint.textContent = 'Guest password: LovingStrangers';
            }
        }

        // ==================== CONNECTION FUNCTIONS ====================
        async function handleConnect() {
            debugLog('=== STARTING CONNECTION ===');
            
            // Get values
            const selectedRole = userSelect.value;
            const password = passwordInput.value;
            
            debugLog(`Role: ${selectedRole}, Password: ${password ? '***' : '(empty)'}`);
            
            // Hide errors
            passwordError.style.display = 'none';
            connectionError.style.display = 'none';
            
            // Validate password
            let isValid = false;
            if (selectedRole === 'host') {
                isValid = password === 'Mira4994Mira';
                appState.isHost = true;
                appState.userName = "Host";
            } else {
                isValid = password === 'LovingStrangers';
                appState.isHost = false;
                appState.userName = "Guest";
            }
            
            if (!isValid) {
                debugLog('‚ùå Invalid password');
                passwordError.style.display = 'block';
                passwordInput.focus();
                passwordInput.select();
                return;
            }
            
            debugLog('‚úÖ Password validated');
            
            // Show loading
            const originalBtnText = connectBtn.innerHTML;
            connectBtn.disabled = true;
            connectBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Connecting...';
            
            try {
                // Generate IDs
                appState.userId = generateUserId();
                appState.sessionId = generateSessionId();
                
                debugLog(`Generated User ID: ${appState.userId}`);
                debugLog(`Generated Session ID: ${appState.sessionId}`);
                
                // Connect to database
                const success = await createOrJoinSession();
                
                if (success) {
                    debugLog('‚úÖ Database connection successful');
                    
                    // Save session
                    localStorage.setItem('writeToMe_session', JSON.stringify({
                        isHost: appState.isHost,
                        userName: appState.userName,
                        userId: appState.userId,
                        sessionId: appState.sessionId,
                        connectionTime: new Date()
                    }));
                    
                    // Complete login
                    await completeLogin();
                    
                } else {
                    throw new Error('Failed to create/join session');
                }
                
            } catch (error) {
                debugLog('‚ùå Connection failed', error);
                connectionError.textContent = `Connection error: ${error.message}`;
                connectionError.style.display = 'block';
                
                // Reset app state
                appState.isHost = false;
                appState.userName = '';
                appState.userId = null;
                appState.sessionId = null;
                
            } finally {
                // Restore button
                connectBtn.disabled = false;
                connectBtn.innerHTML = originalBtnText;
            }
        }

        async function createOrJoinSession() {
            debugLog('Creating/joining session...');
            
            try {
                if (appState.isHost) {
                    // HOST: Create new session
                    debugLog('üëë Creating host session...');
                    
                    const sessionData = {
                        session_id: appState.sessionId,
                        host_id: appState.userId,
                        host_name: appState.userName,
                        is_active: true,
                        created_at: new Date().toISOString(),
                        requires_approval: false
                    };
                    
                    debugLog('Session data:', sessionData);
                    
                    const { data, error } = await supabase
                        .from('sessions')
                        .insert([sessionData])
                        .select()
                        .single();
                    
                    if (error) {
                        debugLog('Error creating session:', error);
                        
                        // Check if session already exists
                        const { data: existing } = await supabase
                            .from('sessions')
                            .select('*')
                            .eq('session_id', appState.sessionId)
                            .single();
                        
                        if (existing) {
                            debugLog('‚úÖ Using existing session');
                            return true;
                        }
                        
                        throw error;
                    }
                    
                    debugLog('‚úÖ Session created:', data);
                    return true;
                    
                } else {
                    // GUEST: Find and join session
                    debugLog('üë§ Guest finding session...');
                    
                    // Get active sessions
                    const { data: sessions, error } = await supabase
                        .from('sessions')
                        .select('*')
                        .eq('is_active', true)
                        .order('created_at', { ascending: false })
                        .limit(1);
                    
                    if (error) {
                        debugLog('Error finding sessions:', error);
                        throw error;
                    }
                    
                    if (!sessions || sessions.length === 0) {
                        alert('No active sessions found. Please ask a host to create a session first.');
                        return false;
                    }
                    
                    const session = sessions[0];
                    appState.sessionId = session.session_id;
                    
                    debugLog(`‚úÖ Found session: ${session.session_id}`);
                    
                    // Update session with guest info
                    const { error: updateError } = await supabase
                        .from('sessions')
                        .update({
                            guest_id: appState.userId,
                            guest_name: appState.userName,
                            guest_connected_at: new Date().toISOString()
                        })
                        .eq('session_id', session.session_id);
                    
                    if (updateError) {
                        debugLog('Error updating session:', updateError);
                        throw updateError;
                    }
                    
                    debugLog('‚úÖ Guest added to session');
                    return true;
                }
                
            } catch (error) {
                debugLog('‚ùå Session creation/join failed', error);
                throw error;
            }
        }

        async function completeLogin() {
            debugLog('Completing login...');
            
            // Hide modal
            connectionModal.style.display = 'none';
            
            // Update app state
            appState.isConnected = true;
            
            // Update UI
            updateUIAfterConnection();
            
            // Save IP
            try {
                const ip = await getRealIP();
                debugLog(`Detected IP: ${ip}`);
                await saveIPAddress(ip);
            } catch (ipError) {
                debugLog('Could not save IP:', ipError);
            }
            
            // Load chat history
            await loadChatHistory();
            
            // Setup real-time
            setupRealtimeSubscription();
            
            // Send welcome message
            await saveMessageToDB('System', `${appState.userName} has connected.`);
            
            // Load sessions if host
            if (appState.isHost) {
                loadSessions();
            }
            
            debugLog('‚úÖ Login complete');
        }

        async function verifySessionExists() {
            try {
                const { data, error } = await supabase
                    .from('sessions')
                    .select('session_id')
                    .eq('session_id', appState.sessionId)
                    .eq('is_active', true)
                    .single();
                
                if (error || !data) {
                    return false;
                }
                
                return true;
            } catch (error) {
                debugLog('Error verifying session:', error);
                return false;
            }
        }

        function updateUIAfterConnection() {
            debugLog('Updating UI after connection...');
            
            // Update status
            statusIndicator.classList.remove('offline');
            userRoleDisplay.textContent = `${appState.userName} (Connected)`;
            logoutBtn.style.display = 'flex';
            
            // Enable chat
            messageInput.disabled = false;
            sendMessageBtn.disabled = false;
            attachImageBtn.disabled = false;
            messageInput.focus();
            
            // Update chat title
            updateChatTitle();
            
            debugLog('‚úÖ UI updated');
        }

        function updateChatTitle() {
            if (appState.viewingHistory) {
                chatTitle.textContent = 'Historical Chat';
                historyIndicator.style.display = 'inline-block';
                returnToActiveBtn.style.display = 'flex';
                messageInput.disabled = true;
                sendMessageBtn.disabled = true;
                attachImageBtn.disabled = true;
            } else {
                chatTitle.textContent = 'Secure Chat';
                historyIndicator.style.display = 'none';
                returnToActiveBtn.style.display = 'none';
                messageInput.disabled = false;
                sendMessageBtn.disabled = false;
                attachImageBtn.disabled = false;
            }
        }

        // ==================== DATABASE TESTING ====================
        async function testDatabaseConnection() {
            debugLog('=== TESTING DATABASE CONNECTION ===');
            
            try {
                // Test 1: Basic connection
                debugLog('Test 1: Testing Supabase connection...');
                const { data, error } = await supabase
                    .from('sessions')
                    .select('count', { count: 'exact', head: true });
                
                if (error) {
                    debugLog('‚ùå Supabase connection failed:', error);
                    showError(`Cannot connect to database: ${error.message}`);
                    return false;
                }
                
                debugLog('‚úÖ Supabase connection OK');
                
                // Test 2: Check sessions table
                debugLog('Test 2: Checking sessions table...');
                const { data: sessions, error: sessionsError } = await supabase
                    .from('sessions')
                    .select('*')
                    .limit(1);
                
                if (sessionsError) {
                    debugLog('‚ùå Sessions table error:', sessionsError);
                    
                    // Check if table exists by trying to create a test record
                    debugLog('Attempting to create test session...');
                    const testData = {
                        session_id: 'test_session_' + Date.now(),
                        host_id: 'test_user',
                        host_name: 'Test Host',
                        is_active: false,
                        created_at: new Date().toISOString()
                    };
                    
                    const { error: testError } = await supabase
                        .from('sessions')
                        .insert([testData]);
                    
                    if (testError) {
                        debugLog('‚ùå Cannot write to sessions table:', testError);
                        showError(`Database error: ${testError.message}\n\nMake sure:\n1. The 'sessions' table exists\n2. RLS policies allow inserts\n3. Table has required columns`);
                        return false;
                    }
                }
                
                debugLog('‚úÖ Sessions table OK');
                
                // Test 3: Check messages table
                debugLog('Test 3: Checking messages table...');
                const { error: messagesError } = await supabase
                    .from('messages')
                    .select('count', { count: 'exact', head: true });
                
                if (messagesError) {
                    debugLog('‚ö†Ô∏è Messages table may not exist or have permission issues:', messagesError);
                } else {
                    debugLog('‚úÖ Messages table OK');
                }
                
                debugLog('=== ALL TESTS COMPLETE ===');
                return true;
                
            } catch (error) {
                debugLog('‚ùå Database test failed:', error);
                showError(`Database test failed: ${error.message}`);
                return false;
            }
        }

        // ==================== CHAT FUNCTIONS ====================
        async function loadChatHistory(sessionId = appState.sessionId) {
            try {
                debugLog(`Loading chat history for session: ${sessionId}`);
                
                const { data: messages, error } = await supabase
                    .from('messages')
                    .select('*')
                    .eq('session_id', sessionId)
                    .order('created_at', { ascending: true });
                
                if (error) {
                    debugLog('Error loading messages:', error);
                    throw error;
                }
                
                chatMessages.innerHTML = '';
                appState.messages = messages || [];
                
                if (appState.messages.length === 0) {
                    const welcomeMsg = appState.viewingHistory 
                        ? 'No messages found in this historical chat.'
                        : 'Welcome to the chat! Start the conversation.';
                    
                    const systemDiv = document.createElement('div');
                    systemDiv.className = 'message system';
                    systemDiv.innerHTML = `
                        <div>${welcomeMsg}</div>
                        <div class="message-time">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                    `;
                    chatMessages.appendChild(systemDiv);
                } else {
                    appState.messages.forEach(msg => {
                        const messageType = msg.sender_id === appState.userId ? 'sent' : 'received';
                        displayMessage(msg, messageType);
                    });
                }
                
                chatMessages.scrollTop = chatMessages.scrollHeight;
                debugLog(`Loaded ${appState.messages.length} messages`);
                
            } catch (error) {
                debugLog('Error loading chat history:', error);
                addSystemMessage('Error loading chat history.');
            }
        }

        function displayMessage(msg, type = 'received') {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.dataset.messageId = msg.id;
            
            let content = msg.message;
            let imageHtml = '';
            
            // Check if message contains an image
            if (msg.message.startsWith('data:image/') || msg.message.match(/\.(jpg|jpeg|png|gif|webp)(\?.*)?$/i)) {
                content = '';
                imageHtml = `<img src="${msg.message}" alt="Shared image" class="message-image" onclick="previewImage('${msg.message}')">`;
            }
            
            messageDiv.innerHTML = `
                <div class="message-sender">${msg.sender_name}</div>
                <div>${content}</div>
                ${imageHtml}
                <div class="message-time">${new Date(msg.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                ${!appState.viewingHistory && msg.sender_id === appState.userId ? `
                    <div class="message-actions">
                        <button class="message-action-btn" onclick="editMessage('${msg.id}')" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="message-action-btn" onclick="deleteMessage('${msg.id}')" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                        <button class="message-action-btn" onclick="replyToMessage('${msg.id}')" title="Reply">
                            <i class="fas fa-reply"></i>
                        </button>
                    </div>
                ` : ''}
            `;
            
            chatMessages.appendChild(messageDiv);
        }

        async function sendMessage() {
            const messageText = messageInput.value.trim();
            if (!messageText && !appState.editingMessage) return;
            
            debugLog('Sending message:', messageText.substring(0, 50) + (messageText.length > 50 ? '...' : ''));
            
            if (appState.editingMessage) {
                await updateMessage(appState.editingMessage, messageText);
                appState.editingMessage = null;
                messageInput.value = '';
                cancelReply();
                updateCharCount();
                return;
            }
            
            const messageData = {
                session_id: appState.sessionId,
                sender_id: appState.userId,
                sender_name: appState.userName,
                message: messageText,
                created_at: new Date().toISOString(),
                reply_to: appState.replyTo
            };
            
            // Clear input
            messageInput.value = '';
            updateCharCount();
            cancelReply();
            
            try {
                const { data, error } = await supabase
                    .from('messages')
                    .insert([messageData])
                    .select()
                    .single();
                
                if (error) {
                    debugLog('Error saving message:', error);
                    addSystemMessage('Error sending message.');
                    return;
                }
                
                // Display locally
                displayMessage(data, 'sent');
                chatMessages.scrollTop = chatMessages.scrollHeight;
                debugLog('‚úÖ Message sent');
                
            } catch (error) {
                debugLog('Error sending message:', error);
                addSystemMessage('Error sending message.');
            }
        }

        async function saveMessageToDB(senderName, messageText) {
            try {
                await supabase
                    .from('messages')
                    .insert([{
                        session_id: appState.sessionId,
                        sender_id: appState.userId,
                        sender_name: senderName,
                        message: messageText,
                        created_at: new Date().toISOString()
                    }]);
                
                debugLog('System message saved:', messageText);
            } catch (error) {
                debugLog('Error saving system message:', error);
            }
        }

        // ==================== IMAGE HANDLING ====================
        async function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Check file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('Image must be less than 5MB');
                return;
            }
            
            // Convert to base64
            const reader = new FileReader();
            reader.onload = async (e) => {
                const base64Image = e.target.result;
                
                const messageData = {
                    session_id: appState.sessionId,
                    sender_id: appState.userId,
                    sender_name: appState.userName,
                    message: base64Image,
                    created_at: new Date().toISOString(),
                    reply_to: appState.replyTo
                };
                
                try {
                    const { data, error } = await supabase
                        .from('messages')
                        .insert([messageData])
                        .select()
                        .single();
                    
                    if (error) {
                        debugLog('Error saving image:', error);
                        addSystemMessage('Error sending image.');
                        return;
                    }
                    
                    displayMessage(data, 'sent');
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                    cancelReply();
                    debugLog('‚úÖ Image sent');
                    
                } catch (error) {
                    debugLog('Error sending image:', error);
                    addSystemMessage('Error sending image.');
                }
            };
            
            reader.readAsDataURL(file);
            imageUpload.value = '';
        }

        // ==================== MESSAGE ACTIONS ====================
        async function updateMessage(messageId, newText) {
            try {
                await supabase
                    .from('messages')
                    .update({ 
                        message: newText,
                        edited_at: new Date().toISOString()
                    })
                    .eq('id', messageId);
                
                // Update local display
                const messageDiv = chatMessages.querySelector(`[data-message-id="${messageId}"]`);
                if (messageDiv) {
                    const contentDiv = messageDiv.querySelector('div:nth-child(2)');
                    if (contentDiv) {
                        contentDiv.textContent = newText + ' (edited)';
                    }
                }
                
                addSystemMessage('Message updated.');
                debugLog('Message updated:', messageId);
                
            } catch (error) {
                debugLog('Error updating message:', error);
                addSystemMessage('Error updating message.');
            }
        }

        async function deleteMessage(messageId) {
            if (!confirm('Delete this message?')) return;
            
            try {
                await supabase
                    .from('messages')
                    .delete()
                    .eq('id', messageId);
                
                // Remove from DOM
                const messageDiv = chatMessages.querySelector(`[data-message-id="${messageId}"]`);
                if (messageDiv) {
                    messageDiv.remove();
                }
                
                addSystemMessage('Message deleted.');
                debugLog('Message deleted:', messageId);
                
            } catch (error) {
                debugLog('Error deleting message:', error);
                addSystemMessage('Error deleting message.');
            }
        }

        function replyToMessage(messageId) {
            const message = appState.messages.find(m => m.id === messageId);
            if (!message) return;
            
            appState.replyTo = messageId;
            replyPreview.style.display = 'block';
            replyPreview.querySelector('.reply-sender').textContent = `Replying to ${message.sender_name}`;
            replyPreview.querySelector('.reply-text').textContent = 
                message.message.length > 100 
                    ? message.message.substring(0, 100) + '...'
                    : message.message;
            
            messageInput.focus();
            debugLog('Replying to message:', messageId);
        }

        function editMessage(messageId) {
            const message = appState.messages.find(m => m.id === messageId);
            if (!message) return;
            
            appState.editingMessage = messageId;
            messageInput.value = message.message;
            messageInput.focus();
            updateCharCount();
            debugLog('Editing message:', messageId);
        }

        function cancelReply() {
            appState.replyTo = null;
            appState.editingMessage = null;
            replyPreview.style.display = 'none';
            debugLog('Reply cancelled');
        }

        // ==================== SESSIONS PANEL ====================
        async function loadSessions() {
            if (!appState.isHost) return;
            
            try {
                debugLog('Loading sessions...');
                
                const { data: sessions, error } = await supabase
                    .from('sessions')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(20);
                
                if (error) throw error;
                
                sessionsList.innerHTML = '';
                
                if (!sessions || sessions.length === 0) {
                    sessionsList.innerHTML = '<div class="session-card"><div class="session-card-header"><h4>No Sessions Found</h4></div></div>';
                    return;
                }
                
                sessions.forEach(session => {
                    const isActive = session.is_active && session.session_id === appState.sessionId;
                    const sessionDiv = document.createElement('div');
                    sessionDiv.className = `session-card ${isActive ? 'active' : ''}`;
                    
                    const guestCount = session.active_guests?.length || 0;
                    
                    sessionDiv.innerHTML = `
                        <div class="session-card-header">
                            <h4>Session ${session.session_id.substring(0, 8)}...</h4>
                            <span class="session-status ${session.is_active ? 'status-active' : 'status-ended'}">
                                ${session.is_active ? 'ACTIVE' : 'ENDED'}
                            </span>
                        </div>
                        <div class="session-details">
                            <p><strong>Host:</strong> ${session.host_name} (${session.host_ip || 'No IP'})</p>
                            <p><strong>Guests:</strong> ${guestCount} connected</p>
                            <p><strong>Started:</strong> ${new Date(session.created_at).toLocaleDateString()}</p>
                        </div>
                        <div class="session-actions">
                            <button class="btn btn-info btn-small" onclick="viewSessionHistory('${session.session_id}')">
                                <i class="fas fa-eye"></i> Review
                            </button>
                            <button class="btn btn-success btn-small" onclick="downloadSessionData('${session.session_id}')">
                                <i class="fas fa-download"></i> Download
                            </button>
                            <button class="btn btn-danger btn-small" onclick="deleteSession('${session.session_id}')">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    `;
                    
                    sessionsList.appendChild(sessionDiv);
                });
                
                debugLog(`Loaded ${sessions.length} sessions`);
                
            } catch (error) {
                debugLog('Error loading sessions:', error);
                sessionsList.innerHTML = '<div class="session-card"><div class="session-card-header"><h4>Error loading sessions</h4></div></div>';
            }
        }

        async function viewSessionHistory(sessionId) {
            appState.viewingHistory = true;
            appState.historicalSessionId = sessionId;
            await loadChatHistory(sessionId);
            updateChatTitle();
            debugLog('Viewing session history:', sessionId);
        }

        function returnToActiveChat() {
            appState.viewingHistory = false;
            appState.historicalSessionId = null;
            loadChatHistory();
            updateChatTitle();
            debugLog('Returned to active chat');
        }

        // ==================== REALTIME SUBSCRIPTIONS ====================
        function setupRealtimeSubscription() {
            debugLog('Setting up real-time subscription...');
            
            // Remove existing subscription
            if (appState.realtimeSubscription) {
                supabase.removeChannel(appState.realtimeSubscription);
            }
            
            // Create new subscription
            appState.realtimeSubscription = supabase
                .channel(`chat-${appState.sessionId}`)
                .on('postgres_changes', {
                    event: 'INSERT',
                    schema: 'public',
                    table: 'messages',
                    filter: `session_id=eq.${appState.sessionId}`
                }, (payload) => {
                    if (payload.new.sender_id !== appState.userId) {
                        appState.messages.push(payload.new);
                        displayMessage(payload.new, 'received');
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                        
                        // Play sound if enabled
                        if (appState.soundEnabled && !appState.viewingHistory) {
                            messageSound.currentTime = 0;
                            messageSound.play().catch(e => debugLog('Audio play failed:', e));
                        }
                        
                        debugLog('New message received');
                    }
                })
                .subscribe((status) => {
                    debugLog(`Realtime subscription status: ${status}`);
                });
            
            debugLog('‚úÖ Real-time subscription active');
        }

        // ==================== HELPER FUNCTIONS ====================
        function showConnectionModal() {
            connectionModal.style.display = 'flex';
            passwordInput.value = '';
            passwordError.style.display = 'none';
            connectionError.style.display = 'none';
            passwordInput.focus();
        }

        async function handleLogout() {
            if (confirm('Are you sure you want to logout?')) {
                debugLog('Logging out...');
                
                // Clear localStorage
                localStorage.removeItem('writeToMe_session');
                
                // Update database
                if (appState.isConnected && appState.sessionId) {
                    try {
                        if (appState.isHost) {
                            await supabase
                                .from('sessions')
                                .update({ 
                                    is_active: false,
                                    ended_at: new Date().toISOString()
                                })
                                .eq('session_id', appState.sessionId);
                        }
                    } catch (error) {
                        debugLog('Logout database error:', error);
                    }
                }
                
                // Reset app state
                appState.isHost = false;
                appState.isConnected = false;
                appState.userName = '';
                appState.userId = null;
                appState.sessionId = null;
                appState.messages = [];
                appState.viewingHistory = false;
                appState.historicalSessionId = null;
                appState.replyTo = null;
                appState.editingMessage = null;
                
                // Reset UI
                statusIndicator.classList.add('offline');
                userRoleDisplay.textContent = 'Disconnected';
                logoutBtn.style.display = 'none';
                messageInput.disabled = true;
                sendMessageBtn.disabled = true;
                attachImageBtn.disabled = true;
                chatMessages.innerHTML = '<div class="message system"><div>Welcome to WriteToMe! Connect to start chatting.</div><div class="message-time">Just now</div></div>';
                pendingGuestsDiv.style.display = 'none';
                sessionsList.innerHTML = '<div class="session-card"><div class="session-card-header"><h4>No Active Sessions</h4></div><div class="session-details"><p>Connect as host to see sessions</p></div></div>';
                updateChatTitle();
                cancelReply();
                
                // Show connection modal
                showConnectionModal();
                
                debugLog('‚úÖ Logout complete');
            }
        }

        function addSystemMessage(text) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message system';
            messageDiv.innerHTML = `
                <div>${text}</div>
                <div class="message-time">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
            `;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            debugLog('System message:', text);
        }

        function updateCharCount() {
            const count = messageInput.value.length;
            charCount.textContent = `${count}/1000`;
            charCount.style.color = count > 900 ? 'var(--danger-red)' : 'var(--text-secondary)';
        }

        function toggleSound() {
            appState.soundEnabled = !appState.soundEnabled;
            localStorage.setItem('writeToMe_sound', appState.soundEnabled);
            updateSoundButton();
            debugLog(`Sound ${appState.soundEnabled ? 'enabled' : 'disabled'}`);
        }

        function updateSoundButton() {
            const icon = soundToggle.querySelector('i');
            icon.className = appState.soundEnabled ? 'fas fa-volume-up' : 'fas fa-volume-mute';
        }

        function generateUserId() {
            return 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function generateSessionId() {
            return 'session_' + Date.now().toString(36);
        }

        async function getRealIP() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip || "Unknown";
            } catch {
                return "Unknown";
            }
        }

        async function saveIPAddress(ip) {
            try {
                if (appState.isHost) {
                    await supabase
                        .from('sessions')
                        .update({ host_ip: ip })
                        .eq('session_id', appState.sessionId);
                } else {
                    await supabase
                        .from('sessions')
                        .update({ guest_ip: ip })
                        .eq('session_id', appState.sessionId);
                }
                debugLog('IP address saved:', ip);
            } catch (error) {
                debugLog('Error saving IP:', error);
            }
        }

        // ==================== GLOBAL FUNCTIONS ====================
        window.previewImage = function(src) {
            document.getElementById('modalImage').src = src;
            document.getElementById('imageModal').style.display = 'flex';
        };

        window.editMessage = editMessage;
        window.deleteMessage = deleteMessage;
        window.replyToMessage = replyToMessage;
        window.viewSessionHistory = viewSessionHistory;

        window.downloadSessionData = async function(sessionId) {
            try {
                // Get session data
                const { data: session, error: sessionError } = await supabase
                    .from('sessions')
                    .select('*')
                    .eq('session_id', sessionId)
                    .single();
                
                if (sessionError) throw sessionError;
                
                // Get messages
                const { data: messages, error: messagesError } = await supabase
                    .from('messages')
                    .select('*')
                    .eq('session_id', sessionId)
                    .order('created_at', { ascending: true });
                
                if (messagesError) throw messagesError;
                
                // Create data object
                const sessionData = {
                    session: session,
                    messages: messages,
                    exported_at: new Date().toISOString(),
                    exported_by: appState.userName
                };
                
                // Convert to JSON and download
                const dataStr = JSON.stringify(sessionData, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                
                const link = document.createElement('a');
                link.setAttribute('href', dataUri);
                link.setAttribute('download', `session_${sessionId}_${new Date().getTime()}.json`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                addSystemMessage('Session data downloaded.');
                debugLog('Session downloaded:', sessionId);
                
            } catch (error) {
                debugLog('Error downloading session:', error);
                alert('Error downloading session data.');
            }
        };

        window.deleteSession = async function(sessionId) {
            if (!confirm('Delete this session and all its messages?')) return;
            
            try {
                // Delete messages first
                await supabase
                    .from('messages')
                    .delete()
                    .eq('session_id', sessionId);
                
                // Delete session
                await supabase
                    .from('sessions')
                    .delete()
                    .eq('session_id', sessionId);
                
                // Reload sessions
                loadSessions();
                
                // If viewing this session, go back to active
                if (appState.historicalSessionId === sessionId) {
                    returnToActiveChat();
                }
                
                addSystemMessage('Session deleted.');
                debugLog('Session deleted:', sessionId);
                
            } catch (error) {
                debugLog('Error deleting session:', error);
                alert('Error deleting session.');
            }
        };

        debugLog('‚úÖ Script loaded successfully');
    </script>
</body>
</html>
