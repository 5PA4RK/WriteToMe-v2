<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WriteToMe - Secure Chat</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --dark-bg: #2a2a2a;
            --darker-bg: #333333;
            --card-bg: #3a3a3a;
            --border-color: #555;
            --text-primary: #f8f8f8;
            --text-secondary: #dddddd;
            --accent-orange: #ff9800;
            --accent-orange-dark: #e68900;
            --success-green: #4caf50;
            --danger-red: #f44336;
            --warning-yellow: #ffc107;
            --info-blue: #2196f3;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--dark-bg);
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            width: 100%;
        }

        header {
            background-color: var(--darker-bg);
            padding: 15px 20px;
            border-bottom: 2px solid var(--accent-orange);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo i {
            color: var(--accent-orange);
            font-size: 28px;
        }

        .logo h1 {
            font-size: 24px;
            color: var(--accent-orange);
            letter-spacing: 1px;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-status {
            display: flex;
            align-items: center;
            gap: 10px;
            background-color: var(--card-bg);
            padding: 8px 15px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: var(--success-green);
        }

        .status-indicator.offline {
            background-color: var(--danger-red);
        }

        .main-app {
            display: flex;
            gap: 25px;
            padding: 25px 0;
        }

        .chat-section {
            flex: 2;
            background-color: var(--card-bg);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            overflow: hidden;
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            height: 75vh;
        }

        .sessions-panel {
            flex: 1;
            background-color: var(--card-bg);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            overflow: hidden;
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            height: 75vh;
        }

        .section-header {
            background-color: var(--darker-bg);
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-header h2 {
            color: var(--accent-orange);
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chat-title {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }

        .history-indicator {
            background-color: var(--info-blue);
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }

        .active-chat-btn {
            background-color: var(--success-green);
            color: white;
            padding: 6px 15px;
            border-radius: 6px;
            font-size: 12px;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            text-decoration: none;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 12px;
            position: relative;
            line-height: 1.4;
            transition: all 0.2s;
        }

        .message:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }

        .message.sent {
            align-self: flex-end;
            background-color: var(--accent-orange);
            color: var(--darker-bg);
        }

        .message.received {
            align-self: flex-start;
            background-color: #555555;
            color: var(--text-primary);
        }

        .message.system {
            align-self: center;
            background-color: rgba(33, 150, 243, 0.2);
            color: var(--text-primary);
            max-width: 90%;
            text-align: center;
            border: 1px solid var(--info-blue);
        }

        .message-image {
            max-width: 300px;
            border-radius: 8px;
            margin-top: 8px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .message-image:hover {
            transform: scale(1.02);
        }

        .message-sender {
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 5px;
            color: var(--accent-orange-dark);
        }

        .message.sent .message-sender {
            color: #000;
        }

        .message-time {
            font-size: 11px;
            text-align: right;
            margin-top: 5px;
            opacity: 0.8;
        }

        .message-actions {
            position: absolute;
            top: 5px;
            right: 5px;
            display: none;
            gap: 5px;
        }

        .message:hover .message-actions {
            display: flex;
        }

        .message-action-btn {
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            border-radius: 4px;
            width: 24px;
            height: 24px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .message-action-btn:hover {
            background: rgba(0, 0, 0, 0.9);
        }

        .chat-input-area {
            padding: 15px 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .message-input-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .chat-input {
            width: 100%;
            padding: 12px 16px;
            background-color: var(--darker-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s;
            resize: none;
            min-height: 60px;
            max-height: 120px;
        }

        .chat-input:focus {
            border-color: var(--accent-orange);
        }

        .input-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .file-upload-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 20px;
            padding: 5px;
        }

        .file-upload-btn:hover {
            color: var(--accent-orange);
        }

        .btn {
            padding: 10px 20px;
            background-color: var(--accent-orange);
            color: var(--darker-bg);
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 14px;
        }

        .btn:hover {
            background-color: var(--accent-orange-dark);
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-danger {
            background-color: var(--danger-red);
            color: white;
        }

        .btn-danger:hover {
            background-color: #d32f2f;
        }

        .btn-success {
            background-color: var(--success-green);
            color: white;
        }

        .btn-info {
            background-color: var(--info-blue);
            color: white;
        }

        .btn-secondary {
            background-color: var(--border-color);
            color: var(--text-primary);
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 12px;
        }

        .sessions-list {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .session-card {
            background-color: #333333;
            border-radius: 8px;
            padding: 15px;
            border-left: 4px solid var(--border-color);
            transition: all 0.3s;
        }

        .session-card.active {
            border-left-color: var(--success-green);
            background-color: rgba(76, 175, 80, 0.1);
        }

        .session-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .session-status {
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: bold;
        }

        .status-active {
            background-color: var(--success-green);
            color: white;
        }

        .status-ended {
            background-color: var(--danger-red);
            color: white;
        }

        .session-details {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        .session-details p {
            margin: 3px 0;
        }

        .session-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .session-actions .btn {
            flex: 1;
            min-width: 70px;
        }

        .connection-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: var(--card-bg);
            width: 90%;
            max-width: 400px;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--accent-orange);
        }

        .modal-header {
            background-color: var(--darker-bg);
            padding: 15px 20px;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-header h2 {
            color: var(--accent-orange);
            font-size: 20px;
        }

        .modal-body {
            padding: 20px;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group label {
            color: var(--text-primary);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            background-color: var(--darker-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s;
        }

        .form-input:focus {
            border-color: var(--accent-orange);
        }

        .error-message {
            color: var(--danger-red);
            font-size: 13px;
            margin-top: 5px;
            display: none;
        }

        .password-hint {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px;
            font-style: italic;
        }

        footer {
            margin-top: auto;
            padding: 15px;
            text-align: center;
            color: var(--text-secondary);
            font-size: 13px;
            border-top: 1px solid var(--border-color);
        }

        .typing-indicator {
            padding: 10px 20px;
            font-style: italic;
            color: var(--accent-orange);
            display: none;
            font-size: 13px;
        }

        .typing-indicator.show {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .pending-guests {
            margin: 15px;
            padding: 15px;
            background-color: rgba(255, 152, 0, 0.1);
            border-radius: 8px;
            border: 1px solid var(--accent-orange);
        }

        .guest-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background-color: var(--darker-bg);
            border-radius: 6px;
            margin: 5px 0;
        }

        .guest-actions {
            display: flex;
            gap: 8px;
        }

        .guest-list {
            max-height: 150px;
            overflow-y: auto;
            margin: 10px 0;
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--danger-red);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 11px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sound-toggle {
            position: relative;
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--darker-bg);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-orange);
        }

        /* Image preview modal */
        .image-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .image-modal img {
            max-width: 90%;
            max-height: 90%;
            border-radius: 8px;
        }

        .image-modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            color: white;
            font-size: 30px;
            cursor: pointer;
        }

        /* Reply preview */
        .reply-preview {
            background-color: rgba(255, 152, 0, 0.1);
            border-left: 3px solid var(--accent-orange);
            padding: 8px 12px;
            margin-bottom: 10px;
            border-radius: 6px;
            display: none;
        }

        .reply-preview .reply-sender {
            font-weight: bold;
            font-size: 12px;
            color: var(--accent-orange);
        }

        .reply-preview .reply-text {
            font-size: 13px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .cancel-reply {
            background: none;
            border: none;
            color: var(--danger-red);
            cursor: pointer;
            margin-left: 10px;
        }
        #debugInfo {
    position: fixed;
    top: 10px;
    right: 10px;
    background: #4CAF50;
    color: white;
    padding: 10px;
    border-radius: 5px;
    z-index: 9999;
    max-width: 300px;
    font-size: 12px;
    display: none;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
}

#debugInfo.error {
    background: #f44336;
}
    </style>
</head>
<body>
    <!-- Connection Modal -->
    <div id="connectionModal" class="connection-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-user-shield"></i> WriteToMe - Secure Connection</h2>
            </div>
            <div class="modal-body">
                <div class="login-form">
                    <div class="form-group">
                        <label for="userSelect"><i class="fas fa-user"></i> Select Role:</label>
                        <select id="userSelect" class="form-input">
                            <option value="guest">Guest</option>
                            <option value="host">Host</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="passwordInput"><i class="fas fa-lock"></i> Password:</label>
                        <input type="password" id="passwordInput" class="form-input" placeholder="Enter password">
                        <div id="passwordHint" class="password-hint"></div>
                    </div>
                    
                    <div id="passwordError" class="error-message">
                        Incorrect password for selected role.
                    </div>
                    
                    <button id="connectBtn" class="btn" style="width: 100%;">
                        <i class="fas fa-plug"></i> Connect
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Image Preview Modal -->
    <div id="imageModal" class="image-modal">
        <span class="image-modal-close">&times;</span>
        <img id="modalImage" src="" alt="Preview">
    </div>

    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-comment-alt"></i>
                    <h1>WriteToMe</h1>
                </div>
                <div class="header-controls">
                    <div class="user-status">
                        <div id="statusIndicator" class="status-indicator offline"></div>
                        <span id="userRoleDisplay">Disconnected</span>
                    </div>
                    <div class="sound-toggle">
                        <button id="soundToggle" class="btn btn-secondary" style="padding: 8px 12px;">
                            <i class="fas fa-volume-up"></i>
                        </button>
                    </div>
                    <button id="logoutBtn" class="btn btn-secondary" style="display: none;">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="main-app">
            <!-- Chat Section -->
            <section class="chat-section">
                <div class="section-header">
                    <div class="chat-title">
                        <h2><i class="fas fa-comments"></i> <span id="chatTitle">Secure Chat</span></h2>
                        <span id="historyIndicator" class="history-indicator" style="display: none;">Historical Chat</span>
                    </div>
                    <a id="returnToActiveBtn" class="active-chat-btn" style="display: none;">
                        <i class="fas fa-arrow-left"></i> Return to Active Chat
                    </a>
                </div>
                
                <!-- Pending Guests Section (Host Only) -->
                <div id="pendingGuests" class="pending-guests" style="display: none;">
                    <h3><i class="fas fa-user-clock"></i> Pending Guests</h3>
                    <div id="guestList" class="guest-list"></div>
                </div>
                
                <!-- Reply Preview -->
                <div id="replyPreview" class="reply-preview">
                    <div class="reply-header">
                        <span class="reply-sender"></span>
                        <button class="cancel-reply"><i class="fas fa-times"></i></button>
                    </div>
                    <div class="reply-text"></div>
                </div>
                
                <div class="chat-messages" id="chatMessages">
                    <div class="message system">
                        <div>Welcome to WriteToMe! Connect to start chatting.</div>
                        <div class="message-time">Just now</div>
                    </div>
                </div>
                
                <div id="typingIndicator" class="typing-indicator">
                    <i class="fas fa-pencil-alt"></i> <span id="typingUser">User</span> is typing...
                </div>
                
                <div class="chat-input-area">
                    <div class="message-input-container">
                        <textarea 
                            id="messageInput" 
                            class="chat-input" 
                            placeholder="Type your message here... (Press Enter to send, Shift+Enter for new line)" 
                            disabled
                            rows="3"
                        ></textarea>
                        <div class="input-actions">
                            <input type="file" id="imageUpload" accept="image/*" style="display: none;">
                            <button id="attachImageBtn" class="file-upload-btn" disabled>
                                <i class="fas fa-image"></i>
                            </button>
                            <div style="flex: 1;"></div>
                            <span id="charCount" style="font-size: 12px; color: var(--text-secondary);">0/1000</span>
                        </div>
                    </div>
                    <button id="sendMessageBtn" class="btn" disabled>
                        <i class="fas fa-paper-plane"></i> Send
                    </button>
                </div>
            </section>

            <!-- Sessions Panel -->
            <section class="sessions-panel">
                <div class="section-header">
                    <h2><i class="fas fa-history"></i> Chat Sessions</h2>
                    <button id="refreshSessionsBtn" class="btn btn-small">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                <div class="sessions-list" id="sessionsList">
                    <!-- Sessions will be loaded here -->
                    <div class="session-card">
                        <div class="session-card-header">
                            <h4>No Active Sessions</h4>
                        </div>
                        <div class="session-details">
                            <p>Connect as host to see sessions</p>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <footer>
        <div class="container">
            <p>WriteToMe &copy; 2023 - Secure Communication Platform</p>
        </div>
    </footer>

    <!-- Audio for message notification -->
    <audio id="messageSound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-message-pop-alert-2354.mp3" type="audio/mpeg">
    </audio>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://plqvqenoroacvzwtgoxq.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_91IHQ5--y4tDIo8L9X2ZJQ_YeThfdu_';
        
        // Initialize Supabase
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // App State
        const appState = {
            isHost: false,
            isConnected: false,
            userName: '',
            userId: null,
            sessionId: null,
            currentSessionId: null,
            messages: [],
            typingTimeout: null,
            connectionTime: null,
            realtimeSubscription: null,
            viewingHistory: false,
            historicalSessionId: null,
            soundEnabled: true,
            pendingGuests: [],
            activeGuests: [],
            replyTo: null,
            editingMessage: null
        };

        // DOM Elements
        const connectionModal = document.getElementById('connectionModal');
        const userSelect = document.getElementById('userSelect');
        const passwordInput = document.getElementById('passwordInput');
        const passwordHint = document.getElementById('passwordHint');
        const connectBtn = document.getElementById('connectBtn');
        const passwordError = document.getElementById('passwordError');
        const logoutBtn = document.getElementById('logoutBtn');
        const statusIndicator = document.getElementById('statusIndicator');
        const userRoleDisplay = document.getElementById('userRoleDisplay');
        const soundToggle = document.getElementById('soundToggle');
        const chatMessages = document.getElementById('chatMessages');
        const chatTitle = document.getElementById('chatTitle');
        const historyIndicator = document.getElementById('historyIndicator');
        const returnToActiveBtn = document.getElementById('returnToActiveBtn');
        const messageInput = document.getElementById('messageInput');
        const sendMessageBtn = document.getElementById('sendMessageBtn');
        const attachImageBtn = document.getElementById('attachImageBtn');
        const imageUpload = document.getElementById('imageUpload');
        const charCount = document.getElementById('charCount');
        const typingIndicator = document.getElementById('typingIndicator');
        const typingUser = document.getElementById('typingUser');
        const pendingGuestsDiv = document.getElementById('pendingGuests');
        const guestList = document.getElementById('guestList');
        const sessionsList = document.getElementById('sessionsList');
        const refreshSessionsBtn = document.getElementById('refreshSessionsBtn');
        const replyPreview = document.getElementById('replyPreview');
        const messageSound = document.getElementById('messageSound');
        const imageModal = document.getElementById('imageModal');
        const modalImage = document.getElementById('modalImage');
        const imageModalClose = document.querySelector('.image-modal-close');


// Add this function to show debug info in the UI
function showDebugInfo(message, isError = false) {
    console.log(message);
    
    // Create or update debug div
    let debugDiv = document.getElementById('debugInfo');
    if (!debugDiv) {
        debugDiv = document.createElement('div');
        debugDiv.id = 'debugInfo';
        debugDiv.style.cssText = `
            position: fixed;
            top: 10px;
            right: 10px;
            background: ${isError ? '#f44336' : '#4CAF50'};
            color: white;
            padding: 10px;
            border-radius: 5px;
            z-index: 9999;
            max-width: 300px;
            font-size: 12px;
            display: none;
        `;
        document.body.appendChild(debugDiv);
    }
    
    debugDiv.textContent = message;
    debugDiv.style.background = isError ? '#f44336' : '#4CAF50';
    debugDiv.style.display = 'block';
    
    // Auto-hide after 5 seconds
    setTimeout(() => {
        debugDiv.style.display = 'none';
    }, 5000);
}

        // Initialize App
        async function initApp() {
            console.log('üîß Initializing app...');
            
            const savedSession = localStorage.getItem('writeToMe_session');
            if (savedSession) {
                try {
                    const sessionData = JSON.parse(savedSession);
                    appState.isHost = sessionData.isHost;
                    appState.userName = sessionData.userName;
                    appState.userId = sessionData.userId;
                    appState.currentSessionId = sessionData.sessionId;
                    
                    if (await reconnectToSession()) {
                        appState.isConnected = true;
                        connectionModal.style.display = 'none';
                        updateUIAfterConnection();
                        loadChatHistory();
                        setupRealtimeSubscriptions();
                        console.log('‚úÖ Reconnected successfully');
                    } else {
                        localStorage.removeItem('writeToMe_session');
                        connectionModal.style.display = 'flex';
                    }
                } catch (e) {
                    console.error('Error parsing saved session:', e);
                    localStorage.removeItem('writeToMe_session');
                    connectionModal.style.display = 'flex';
                }
            } else {
                connectionModal.style.display = 'flex';
            }
            
            setupEventListeners();
            loadSessions();
            
            // Load sound preference
            appState.soundEnabled = localStorage.getItem('writeToMe_sound') !== 'false';
            updateSoundButton();
        }

        // Setup Event Listeners
        function setupEventListeners() {
            // Connection
            userSelect.addEventListener('change', updatePasswordHint);
            passwordInput.addEventListener('keypress', (e) => e.key === 'Enter' && handleConnect());
            connectBtn.addEventListener('click', handleConnect);
            
            // Logout
            logoutBtn.addEventListener('click', handleLogout);
            
            // Sound toggle
            soundToggle.addEventListener('click', toggleSound);
            
            // Chat
            messageInput.addEventListener('input', handleTyping);
            messageInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            messageInput.addEventListener('input', updateCharCount);
            sendMessageBtn.addEventListener('click', sendMessage);
            
            // Image handling
            attachImageBtn.addEventListener('click', () => imageUpload.click());
            imageUpload.addEventListener('change', handleImageUpload);
            
            // Sessions
            refreshSessionsBtn.addEventListener('click', loadSessions);
            
            // Image modal
            imageModalClose.addEventListener('click', () => imageModal.style.display = 'none');
            imageModal.addEventListener('click', (e) => {
                if (e.target === imageModal) imageModal.style.display = 'none';
            });
            
            // Reply preview
            replyPreview.querySelector('.cancel-reply').addEventListener('click', cancelReply);
            
            // Initialize password hint
            updatePasswordHint();
        }

        function updatePasswordHint() {
            passwordHint.textContent = userSelect.value === 'host' 
                ? 'Host password: Mira4994Mira' 
                : 'Guest password: LovingStrangers';
        }

// Handle Connection
async function handleConnect() {
    console.log('üîå Starting connection process...');
    
    // Get elements
    const userSelect = document.getElementById('userSelect');
    const passwordInput = document.getElementById('passwordInput');
    const connectBtn = document.getElementById('connectBtn');
    const passwordError = document.getElementById('passwordError');
    
    if (!userSelect || !passwordInput || !connectBtn) {
        console.error('‚ùå Missing form elements');
        showDebugInfo('Missing form elements', true);
        return;
    }
    
    const selectedRole = userSelect.value;
    const password = passwordInput.value;
    
    console.log(`üìù Role: ${selectedRole}, Password length: ${password.length}`);
    
    // Reset error
    if (passwordError) {
        passwordError.style.display = 'none';
    }
    
    // Show loading state
    const originalBtnHTML = connectBtn.innerHTML;
    connectBtn.disabled = true;
    connectBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Connecting...';
    
    // Validate password
    let isValid = false;
    let expectedPassword = '';
    
    if (selectedRole === 'host') {
        expectedPassword = 'Mira4994Mira';
        isValid = password === expectedPassword;
        appState.isHost = true;
        appState.userName = "Host";
        console.log(`üîê Host password check: ${password === expectedPassword ? '‚úì' : '‚úó'}`);
    } else {
        expectedPassword = 'LovingStrangers';
        isValid = password === expectedPassword;
        appState.isHost = false;
        appState.userName = "Guest";
        console.log(`üîê Guest password check: ${password === expectedPassword ? '‚úì' : '‚úó'}`);
    }
    
    if (!isValid) {
        console.log(`‚ùå Password incorrect. Expected: "${expectedPassword}", Got: "${password}"`);
        
        if (passwordError) {
            passwordError.style.display = 'block';
        }
        
        passwordInput.focus();
        passwordInput.select();
        
        // Restore button
        connectBtn.disabled = false;
        connectBtn.innerHTML = originalBtnHTML;
        
        showDebugInfo(`Password incorrect for ${selectedRole}`, true);
        return;
    }
    
    console.log('‚úÖ Password validated successfully');
    
    // Generate IDs
    appState.userId = generateUserId();
    appState.currentSessionId = generateSessionId();
    appState.connectionTime = new Date();
    
    console.log(`üìã Generated IDs - User: ${appState.userId.substring(0, 15)}..., Session: ${appState.currentSessionId}`);
    
    // Connect to database
    try {
        console.log('üîÑ Attempting to connect to Supabase...');
        const connected = await connectToSupabase();
        
        if (connected) {
            console.log('‚úÖ Supabase connection successful');
            
            appState.isConnected = true;
            
            // Save session to localStorage
            const sessionData = {
                isHost: appState.isHost,
                userName: appState.userName,
                userId: appState.userId,
                sessionId: appState.currentSessionId,
                connectionTime: appState.connectionTime
            };
            
            localStorage.setItem('writeToMe_session', JSON.stringify(sessionData));
            console.log('üíæ Session saved to localStorage');
            
            // Hide connection modal
            connectionModal.style.display = 'none';
            
            // Update UI
            updateUIAfterConnection();
            
            // Save IP address
            try {
                const userIP = await getRealIP();
                console.log(`üåê Detected IP: ${userIP}`);
                await saveUserIP(userIP);
            } catch (ipError) {
                console.warn('‚ö†Ô∏è Could not save IP:', ipError);
            }
            
            // Send system message
            await saveMessageToDB('System', `${appState.userName} has connected.`);
            
            // Setup real-time subscriptions
            setupRealtimeSubscriptions();
            
            // If host, load pending guests
            if (appState.isHost) {
                console.log('üëë Host: Loading pending guests...');
                loadPendingGuests();
            }
            
            // Load chat history
            await loadChatHistory();
            
            showDebugInfo(`Connected as ${appState.userName}`, false);
            console.log('üéâ Connection process completed successfully!');
            
        } else {
            throw new Error('Failed to connect to Supabase');
        }
        
    } catch (error) {
        console.error('‚ùå Connection failed:', error);
        
        // Show error to user
        alert(`Connection failed: ${error.message}\n\nCheck console for details.`);
        
        // Reset button
        connectBtn.disabled = false;
        connectBtn.innerHTML = originalBtnHTML;
        
        showDebugInfo(`Connection failed: ${error.message}`, true);
        
        // Reset app state
        appState.isHost = false;
        appState.isConnected = false;
        appState.userName = '';
        appState.userId = null;
        appState.currentSessionId = null;
        
        return;
    }
    
    // Restore button
    connectBtn.disabled = false;
    connectBtn.innerHTML = originalBtnHTML;
    console.log('üîß Connection process finished');
}

// Connect to Supabase with Guest Approval
async function connectToSupabase() {
    console.log('üîó Starting Supabase connection...');
    
    try {
        if (appState.isHost) {
            console.log('üëë User is HOST - Creating session...');
            
            // Host creates a new session
            const sessionData = {
                session_id: appState.currentSessionId,
                host_id: appState.userId,
                host_name: appState.userName,
                is_active: true,
                created_at: new Date().toISOString(),
                requires_approval: true,
                pending_guests: [],
                approved_guests: [],
                active_guests: []
            };
            
            console.log('üì¶ Session data to insert:', sessionData);
            
            const { data, error } = await supabase
                .from('sessions')
                .insert([sessionData])
                .select()
                .single();
            
            if (error) {
                console.error('‚ùå Error creating session:', error);
                
                // If session already exists, try to use it
                if (error.code === '23505') { // Unique violation
                    console.log('‚ö†Ô∏è Session exists, checking if we can use it...');
                    
                    const { data: existingSession, error: fetchError } = await supabase
                        .from('sessions')
                        .select('*')
                        .eq('session_id', appState.currentSessionId)
                        .single();
                    
                    if (fetchError) {
                        console.error('‚ùå Error fetching existing session:', fetchError);
                        throw fetchError;
                    }
                    
                    console.log('‚úÖ Using existing session:', existingSession);
                    return true;
                }
                
                throw error;
            }
            
            console.log('‚úÖ Session created successfully:', data);
            return true;
            
        } else {
            console.log('üë§ User is GUEST - Finding session to join...');
            
            // Guest tries to find an active session
            const { data: sessions, error: fetchError } = await supabase
                .from('sessions')
                .select('*')
                .eq('is_active', true)
                .order('created_at', { ascending: false })
                .limit(5);
            
            if (fetchError) {
                console.error('‚ùå Error fetching sessions:', fetchError);
                throw fetchError;
            }
            
            console.log(`üìä Found ${sessions?.length || 0} active sessions`);
            
            if (!sessions || sessions.length === 0) {
                alert("‚ùå No active sessions found. Please ask a host to create a session first.");
                return false;
            }
            
            // For simplicity, use the most recent session
            const session = sessions[0];
            console.log('üéØ Selected session:', session.session_id);
            appState.currentSessionId = session.session_id;
            
            // Check if guest is already approved
            const approvedGuests = session.approved_guests || [];
            if (approvedGuests.includes(appState.userId)) {
                console.log('‚úÖ Guest already approved, joining directly...');
                await addGuestToSession();
                return true;
            }
            
            // Check if session requires approval
            if (session.requires_approval) {
                console.log('‚è≥ Session requires approval, adding to pending...');
                
                // Add to pending guests
                const pending = session.pending_guests || [];
                const isAlreadyPending = pending.find(g => g.id === appState.userId);
                
                if (!isAlreadyPending) {
                    const guestInfo = {
                        id: appState.userId,
                        name: appState.userName,
                        timestamp: new Date().toISOString()
                    };
                    
                    pending.push(guestInfo);
                    
                    const { error: updateError } = await supabase
                        .from('sessions')
                        .update({ pending_guests: pending })
                        .eq('session_id', appState.currentSessionId);
                    
                    if (updateError) {
                        console.error('‚ùå Error adding to pending:', updateError);
                        throw updateError;
                    }
                    
                    console.log('‚úÖ Added to pending guests');
                }
                
                // Show waiting screen
                showWaitingScreen();
                startApprovalPolling();
                
                return false; // Not fully connected yet
                
            } else {
                // No approval needed, join directly
                console.log('‚úÖ No approval required, joining directly...');
                await addGuestToSession();
                return true;
            }
        }
        
    } catch (error) {
        console.error('‚ùå Supabase connection error:', error);
        throw error;
    }
}

        async function addGuestToSession() {
            const active = await getActiveGuests();
            const approved = await getApprovedGuests();
            
            // Add to active guests
            const guestData = {
                id: appState.userId,
                name: appState.userName,
                joined_at: new Date().toISOString()
            };
            
            active.push(guestData);
            
            // Add to approved if not already
            if (!approved.includes(appState.userId)) {
                approved.push(appState.userId);
            }
            
            // Remove from pending if exists
            const pending = await getPendingGuests();
            const updatedPending = pending.filter(g => g.id !== appState.userId);
            
            await supabase
                .from('sessions')
                .update({
                    active_guests: active,
                    approved_guests: approved,
                    pending_guests: updatedPending
                })
                .eq('session_id', appState.currentSessionId);
        }

        async function getActiveGuests() {
            const { data } = await supabase
                .from('sessions')
                .select('active_guests')
                .eq('session_id', appState.currentSessionId)
                .single();
            return data?.active_guests || [];
        }

        async function getApprovedGuests() {
            const { data } = await supabase
                .from('sessions')
                .select('approved_guests')
                .eq('session_id', appState.currentSessionId)
                .single();
            return data?.approved_guests || [];
        }

        async function getPendingGuests() {
            const { data } = await supabase
                .from('sessions')
                .select('pending_guests')
                .eq('session_id', appState.currentSessionId)
                .single();
            return data?.pending_guests || [];
        }

        function showWaitingScreen() {
    console.log('‚è≥ Showing waiting screen for guest...');
    
    connectionModal.style.display = 'none';
    
    // Remove existing waiting screen if any
    const existingScreen = document.getElementById('waitingScreen');
    if (existingScreen) {
        document.body.removeChild(existingScreen);
    }
    
    const waitingScreen = document.createElement('div');
    waitingScreen.id = 'waitingScreen';
    waitingScreen.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.95);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1001;
        text-align: center;
        padding: 20px;
    `;
    
    waitingScreen.innerHTML = `
        <div style="background-color: var(--card-bg); padding: 40px; border-radius: 12px; border: 2px solid var(--accent-orange); max-width: 500px; width: 100%;">
            <h2 style="color: var(--accent-orange); margin-bottom: 20px;">
                <i class="fas fa-user-clock"></i> Waiting for Host Approval
            </h2>
            <p style="margin-bottom: 15px; color: var(--text-primary);">
                Your request has been sent to the host (Session ID: ${appState.currentSessionId.substring(0, 10)}...)
            </p>
            <p style="margin-bottom: 25px; color: var(--text-secondary);">
                You will be connected automatically once approved.
            </p>
            <div id="waitingStatus" style="margin-bottom: 25px;">
                <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <div class="status-indicator offline" style="animation: blink 1s infinite;"></div>
                    <span style="color: var(--text-primary);">Waiting for approval...</span>
                </div>
                <div id="waitingTimer" style="margin-top: 10px; font-size: 12px; color: var(--text-secondary);">
                    Waiting time: <span id="timerSeconds">0</span>s
                </div>
            </div>
            <button id="cancelWaitBtn" class="btn btn-danger" style="width: 100%;">
                <i class="fas fa-times"></i> Cancel & Return
            </button>
        </div>
        <style>
            @keyframes blink {
                0%, 100% { opacity: 1; }
                50% { opacity: 0.3; }
            }
        </style>
    `;
    
    document.body.appendChild(waitingScreen);
    
    // Start timer
    let seconds = 0;
    const timerElement = document.getElementById('timerSeconds');
    const timerInterval = setInterval(() => {
        seconds++;
        if (timerElement) {
            timerElement.textContent = seconds;
        }
    }, 1000);
    
    // Cancel button handler
    document.getElementById('cancelWaitBtn').addEventListener('click', () => {
        clearInterval(timerInterval);
        document.body.removeChild(waitingScreen);
        connectionModal.style.display = 'flex';
        showDebugInfo('Connection request cancelled', false);
    });
    
    console.log('‚úÖ Waiting screen displayed');
}

function startApprovalPolling() {
    console.log('üîÑ Starting approval polling...');
    
    let pollCount = 0;
    const maxPolls = 300; // 10 minutes (300 * 2 seconds)
    
    const checkInterval = setInterval(async () => {
        pollCount++;
        console.log(`üîÑ Poll #${pollCount} for approval...`);
        
        try {
            // Get approved guests list
            const { data: session, error } = await supabase
                .from('sessions')
                .select('approved_guests, is_active')
                .eq('session_id', appState.currentSessionId)
                .single();
            
            if (error) {
                console.error('‚ùå Polling error:', error);
                return;
            }
            
            if (!session.is_active) {
                console.log('‚ùå Session is no longer active');
                clearInterval(checkInterval);
                alert('Session has ended by the host.');
                location.reload();
                return;
            }
            
            const approvedGuests = session.approved_guests || [];
            
            if (approvedGuests.includes(appState.userId)) {
                console.log('‚úÖ Guest approved! Completing connection...');
                clearInterval(checkInterval);
                
                // Remove waiting screen
                const waitingScreen = document.getElementById('waitingScreen');
                if (waitingScreen) {
                    document.body.removeChild(waitingScreen);
                }
                
                // Complete guest connection
                await addGuestToSession();
                appState.isConnected = true;
                
                // Save session to localStorage
                localStorage.setItem('writeToMe_session', JSON.stringify({
                    isHost: appState.isHost,
                    userName: appState.userName,
                    userId: appState.userId,
                    sessionId: appState.currentSessionId,
                    connectionTime: new Date()
                }));
                
                // Update UI
                updateUIAfterConnection();
                
                // Load chat and setup real-time
                await loadChatHistory();
                setupRealtimeSubscriptions();
                
                // Add welcome message
                await saveMessageToDB('System', `${appState.userName} has joined the chat.`);
                
                showDebugInfo('Approved! Connected to chat.', false);
                
            } else if (pollCount >= maxPolls) {
                console.log('‚ùå Polling timeout - not approved');
                clearInterval(checkInterval);
                
                const waitingScreen = document.getElementById('waitingScreen');
                if (waitingScreen) {
                    waitingScreen.innerHTML = `
                        <div style="background-color: var(--card-bg); padding: 40px; border-radius: 12px; border: 2px solid var(--danger-red); max-width: 500px;">
                            <h2 style="color: var(--danger-red); margin-bottom: 20px;">
                                <i class="fas fa-exclamation-triangle"></i> Approval Timeout
                            </h2>
                            <p style="margin-bottom: 25px;">The host did not approve your request within 10 minutes.</p>
                            <button id="timeoutReturnBtn" class="btn btn-secondary" style="width: 100%;">
                                <i class="fas fa-arrow-left"></i> Return to Login
                            </button>
                        </div>
                    `;
                    
                    document.getElementById('timeoutReturnBtn').addEventListener('click', () => {
                        document.body.removeChild(waitingScreen);
                        connectionModal.style.display = 'flex';
                    });
                }
            }
            
        } catch (error) {
            console.error('‚ùå Polling error:', error);
        }
    }, 2000); // Check every 2 seconds
}

// Add this function to save user IP
async function saveUserIP(ip) {
    try {
        if (appState.isHost) {
            const { error } = await supabase
                .from('sessions')
                .update({ host_ip: ip })
                .eq('session_id', appState.currentSessionId);
            
            if (error) throw error;
            console.log('‚úÖ Host IP saved');
        } else {
            const { error } = await supabase
                .from('sessions')
                .update({ guest_ip: ip })
                .eq('session_id', appState.currentSessionId);
            
            if (error) throw error;
            console.log('‚úÖ Guest IP saved');
        }
    } catch (error) {
        console.error('‚ùå Error saving IP:', error);
    }
}

        function updateUIAfterConnection() {
            statusIndicator.classList.remove('offline');
            userRoleDisplay.textContent = `${appState.userName} (Connected)`;
            logoutBtn.style.display = 'flex';
            
            // Enable chat controls
            messageInput.disabled = false;
            sendMessageBtn.disabled = false;
            attachImageBtn.disabled = false;
            messageInput.focus();
            
            // Show pending guests for host
            if (appState.isHost) {
                pendingGuestsDiv.style.display = 'block';
                loadPendingGuests();
            }
            
            // Update chat title
            updateChatTitle();
        }

        function updateChatTitle() {
            if (appState.viewingHistory) {
                chatTitle.textContent = 'Historical Chat';
                historyIndicator.style.display = 'inline-block';
                returnToActiveBtn.style.display = 'flex';
                messageInput.disabled = true;
                sendMessageBtn.disabled = true;
            } else {
                chatTitle.textContent = 'Secure Chat';
                historyIndicator.style.display = 'none';
                returnToActiveBtn.style.display = 'none';
                messageInput.disabled = false;
                sendMessageBtn.disabled = false;
            }
        }

        async function reconnectToSession() {
            try {
                const { data: session, error } = await supabase
                    .from('sessions')
                    .select('*')
                    .eq('session_id', appState.currentSessionId)
                    .eq('is_active', true)
                    .single();
                
                if (error || !session) return false;
                
                if (appState.isHost) {
                    return session.host_id === appState.userId;
                } else {
                    const approvedGuests = session.approved_guests || [];
                    return approvedGuests.includes(appState.userId);
                }
            } catch {
                return false;
            }
        }

        async function handleLogout() {
            if (confirm("Are you sure you want to logout?")) {
                localStorage.removeItem('writeToMe_session');
                
                if (appState.isConnected && appState.currentSessionId) {
                    try {
                        if (appState.isHost) {
                            await supabase
                                .from('sessions')
                                .update({ 
                                    is_active: false,
                                    ended_at: new Date().toISOString()
                                })
                                .eq('session_id', appState.currentSessionId);
                        } else {
                            // Remove from active guests
                            const active = await getActiveGuests();
                            const updatedActive = active.filter(g => g.id !== appState.userId);
                            
                            await supabase
                                .from('sessions')
                                .update({ active_guests: updatedActive })
                                .eq('session_id', appState.currentSessionId);
                        }
                    } catch (error) {
                        console.error('Logout error:', error);
                    }
                }
                
                // Reset app
                resetApp();
                connectionModal.style.display = 'flex';
            }
        }

        function resetApp() {
            appState.isHost = false;
            appState.isConnected = false;
            appState.userName = '';
            appState.userId = null;
            appState.currentSessionId = null;
            appState.messages = [];
            appState.viewingHistory = false;
            appState.historicalSessionId = null;
            appState.replyTo = null;
            appState.editingMessage = null;
            
            // Reset UI
            statusIndicator.classList.add('offline');
            userRoleDisplay.textContent = "Disconnected";
            logoutBtn.style.display = 'none';
            messageInput.disabled = true;
            sendMessageBtn.disabled = true;
            attachImageBtn.disabled = true;
            chatMessages.innerHTML = '<div class="message system"><div>Welcome to WriteToMe! Connect to start chatting.</div><div class="message-time">Just now</div></div>';
            pendingGuestsDiv.style.display = 'none';
            sessionsList.innerHTML = '<div class="session-card"><div class="session-card-header"><h4>No Active Sessions</h4></div><div class="session-details"><p>Connect as host to see sessions</p></div></div>';
            updateChatTitle();
            cancelReply();
        }

        async function loadChatHistory(sessionId = appState.currentSessionId) {
            try {
                console.log('üìú Loading chat history for session:', sessionId);
                
                const { data: messages, error } = await supabase
                    .from('messages')
                    .select('*')
                    .eq('session_id', sessionId)
                    .order('created_at', { ascending: true });
                
                if (error) throw error;
                
                chatMessages.innerHTML = '';
                appState.messages = messages || [];
                
                if (appState.messages.length === 0) {
                    const welcomeMsg = appState.viewingHistory 
                        ? 'No messages found in this historical chat.'
                        : 'Welcome to the chat! Start the conversation.';
                    
                    const systemDiv = document.createElement('div');
                    systemDiv.className = 'message system';
                    systemDiv.innerHTML = `
                        <div>${welcomeMsg}</div>
                        <div class="message-time">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                    `;
                    chatMessages.appendChild(systemDiv);
                } else {
                    appState.messages.forEach(msg => {
                        const messageType = msg.sender_id === appState.userId ? 'sent' : 'received';
                        displayMessage(msg, messageType);
                    });
                }
                
                chatMessages.scrollTop = chatMessages.scrollHeight;
                console.log(`‚úÖ Loaded ${appState.messages.length} messages`);
            } catch (error) {
                console.error('Error loading chat:', error);
                addSystemMessage('Error loading chat history.');
            }
        }

        function displayMessage(msg, type = 'received') {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.dataset.messageId = msg.id;
            
            let content = msg.message;
            let imageHtml = '';
            
            // Check if message contains an image (URL or base64)
            if (msg.message.startsWith('data:image/') || msg.message.match(/\.(jpg|jpeg|png|gif|webp)(\?.*)?$/i)) {
                content = '';
                imageHtml = `<img src="${msg.message}" alt="Shared image" class="message-image" onclick="previewImage('${msg.message}')">`;
            }
            
            // Check if it's a reply
            let replyHtml = '';
            if (msg.reply_to) {
                const repliedMsg = appState.messages.find(m => m.id === msg.reply_to);
                if (repliedMsg) {
                    replyHtml = `
                        <div class="reply-preview" style="margin-bottom: 8px; padding: 6px 10px; background: rgba(255,255,255,0.1); border-radius: 6px; border-left: 3px solid var(--accent-orange);">
                            <div style="font-size: 11px; color: var(--accent-orange);">Replying to ${repliedMsg.sender_name}</div>
                            <div style="font-size: 12px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                ${repliedMsg.message.length > 50 ? repliedMsg.message.substring(0, 50) + '...' : repliedMsg.message}
                            </div>
                        </div>
                    `;
                }
            }
            
            messageDiv.innerHTML = `
                <div class="message-sender">${msg.sender_name}</div>
                ${replyHtml}
                <div>${content}</div>
                ${imageHtml}
                <div class="message-time">${new Date(msg.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                ${!appState.viewingHistory && msg.sender_id === appState.userId ? `
                    <div class="message-actions">
                        <button class="message-action-btn" onclick="editMessage('${msg.id}')" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="message-action-btn" onclick="deleteMessage('${msg.id}')" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                        <button class="message-action-btn" onclick="replyToMessage('${msg.id}')" title="Reply">
                            <i class="fas fa-reply"></i>
                        </button>
                    </div>
                ` : ''}
            `;
            
            chatMessages.appendChild(messageDiv);
        }

        async function sendMessage() {
            const messageText = messageInput.value.trim();
            if (!messageText && !appState.editingMessage) return;
            
            if (appState.editingMessage) {
                await updateMessage(appState.editingMessage, messageText);
                appState.editingMessage = null;
                messageInput.value = '';
                cancelReply();
                return;
            }
            
            const messageData = {
                session_id: appState.currentSessionId,
                sender_id: appState.userId,
                sender_name: appState.userName,
                message: messageText,
                created_at: new Date().toISOString(),
                reply_to: appState.replyTo
            };
            
            // Clear input
            messageInput.value = '';
            updateCharCount();
            cancelReply();
            
            // Save to database
            const { data, error } = await supabase
                .from('messages')
                .insert([messageData])
                .select()
                .single();
            
            if (error) {
                console.error('Error saving message:', error);
                addSystemMessage('Error sending message.');
                return;
            }
            
            // Display locally
            displayMessage(data, 'sent');
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        async function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Check file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('Image must be less than 5MB');
                return;
            }
            
            // Convert to base64
            const reader = new FileReader();
            reader.onload = async (e) => {
                const base64Image = e.target.result;
                
                const messageData = {
                    session_id: appState.currentSessionId,
                    sender_id: appState.userId,
                    sender_name: appState.userName,
                    message: base64Image,
                    created_at: new Date().toISOString(),
                    reply_to: appState.replyTo
                };
                
                const { data, error } = await supabase
                    .from('messages')
                    .insert([messageData])
                    .select()
                    .single();
                
                if (error) {
                    console.error('Error saving image:', error);
                    addSystemMessage('Error sending image.');
                    return;
                }
                
                displayMessage(data, 'sent');
                chatMessages.scrollTop = chatMessages.scrollHeight;
                cancelReply();
            };
            
            reader.readAsDataURL(file);
            imageUpload.value = '';
        }

        async function updateMessage(messageId, newText) {
            try {
                await supabase
                    .from('messages')
                    .update({ 
                        message: newText,
                        edited_at: new Date().toISOString()
                    })
                    .eq('id', messageId);
                
                // Update local display
                const messageDiv = chatMessages.querySelector(`[data-message-id="${messageId}"]`);
                if (messageDiv) {
                    const contentDiv = messageDiv.querySelector('div:nth-child(2)');
                    if (contentDiv) {
                        contentDiv.textContent = newText + ' (edited)';
                    }
                }
                
                addSystemMessage('Message updated.');
            } catch (error) {
                console.error('Error updating message:', error);
                addSystemMessage('Error updating message.');
            }
        }

        async function deleteMessage(messageId) {
            if (!confirm('Delete this message?')) return;
            
            try {
                await supabase
                    .from('messages')
                    .delete()
                    .eq('id', messageId);
                
                // Remove from DOM
                const messageDiv = chatMessages.querySelector(`[data-message-id="${messageId}"]`);
                if (messageDiv) {
                    messageDiv.remove();
                }
                
                addSystemMessage('Message deleted.');
            } catch (error) {
                console.error('Error deleting message:', error);
                addSystemMessage('Error deleting message.');
            }
        }

        function replyToMessage(messageId) {
            const message = appState.messages.find(m => m.id === messageId);
            if (!message) return;
            
            appState.replyTo = messageId;
            replyPreview.style.display = 'block';
            replyPreview.querySelector('.reply-sender').textContent = `Replying to ${message.sender_name}`;
            replyPreview.querySelector('.reply-text').textContent = 
                message.message.length > 100 
                    ? message.message.substring(0, 100) + '...'
                    : message.message;
            
            messageInput.focus();
        }

        function editMessage(messageId) {
            const message = appState.messages.find(m => m.id === messageId);
            if (!message) return;
            
            appState.editingMessage = messageId;
            messageInput.value = message.message;
            messageInput.focus();
            updateCharCount();
        }

        function cancelReply() {
            appState.replyTo = null;
            appState.editingMessage = null;
            replyPreview.style.display = 'none';
        }

        function handleTyping() {
            if (!appState.typingTimeout) {
                // Notify others that user is typing
                // This would require a real-time typing indicator table
                // For now, we'll just set a timeout
            }
            
            clearTimeout(appState.typingTimeout);
            appState.typingTimeout = setTimeout(() => {
                appState.typingTimeout = null;
            }, 1000);
        }

        function updateCharCount() {
            const count = messageInput.value.length;
            charCount.textContent = `${count}/1000`;
            charCount.style.color = count > 900 ? 'var(--danger-red)' : 'var(--text-secondary)';
        }

        function addSystemMessage(text) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message system';
            messageDiv.innerHTML = `
                <div>${text}</div>
                <div class="message-time">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
            `;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        async function loadSessions() {
            if (!appState.isHost) return;
            
            try {
                const { data: sessions, error } = await supabase
                    .from('sessions')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(20);
                
                if (error) throw error;
                
                sessionsList.innerHTML = '';
                
                if (!sessions || sessions.length === 0) {
                    sessionsList.innerHTML = '<div class="session-card"><div class="session-card-header"><h4>No Sessions Found</h4></div></div>';
                    return;
                }
                
                sessions.forEach(session => {
                    const isActive = session.is_active && session.session_id === appState.currentSessionId;
                    const sessionDiv = document.createElement('div');
                    sessionDiv.className = `session-card ${isActive ? 'active' : ''}`;
                    
                    const guestCount = session.active_guests?.length || 0;
                    const messageCount = session.message_count || 0;
                    
                    sessionDiv.innerHTML = `
                        <div class="session-card-header">
                            <h4>Session ${session.session_id.substring(0, 8)}...</h4>
                            <span class="session-status ${session.is_active ? 'status-active' : 'status-ended'}">
                                ${session.is_active ? 'ACTIVE' : 'ENDED'}
                            </span>
                        </div>
                        <div class="session-details">
                            <p><strong>Host:</strong> ${session.host_name} (${session.host_ip || 'No IP'})</p>
                            <p><strong>Guests:</strong> ${guestCount} connected</p>
                            <p><strong>Messages:</strong> ${messageCount}</p>
                            <p><strong>Started:</strong> ${new Date(session.created_at).toLocaleDateString()}</p>
                        </div>
                        <div class="session-actions">
                            <button class="btn btn-info btn-small" onclick="viewSessionHistory('${session.session_id}')">
                                <i class="fas fa-eye"></i> Review
                            </button>
                            <button class="btn btn-success btn-small" onclick="downloadSessionData('${session.session_id}')">
                                <i class="fas fa-download"></i> Download
                            </button>
                            <button class="btn btn-danger btn-small" onclick="deleteSession('${session.session_id}')">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    `;
                    
                    sessionsList.appendChild(sessionDiv);
                });
            } catch (error) {
                console.error('Error loading sessions:', error);
                sessionsList.innerHTML = '<div class="session-card"><div class="session-card-header"><h4>Error loading sessions</h4></div></div>';
            }
        }

        async function viewSessionHistory(sessionId) {
            appState.viewingHistory = true;
            appState.historicalSessionId = sessionId;
            await loadChatHistory(sessionId);
            updateChatTitle();
        }

        async function downloadSessionData(sessionId) {
            try {
                // Get session data
                const { data: session, error: sessionError } = await supabase
                    .from('sessions')
                    .select('*')
                    .eq('session_id', sessionId)
                    .single();
                
                if (sessionError) throw sessionError;
                
                // Get messages
                const { data: messages, error: messagesError } = await supabase
                    .from('messages')
                    .select('*')
                    .eq('session_id', sessionId)
                    .order('created_at', { ascending: true });
                
                if (messagesError) throw messagesError;
                
                // Create data object
                const sessionData = {
                    session: session,
                    messages: messages,
                    exported_at: new Date().toISOString(),
                    exported_by: appState.userName
                };
                
                // Convert to JSON and download
                const dataStr = JSON.stringify(sessionData, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                
                const link = document.createElement('a');
                link.setAttribute('href', dataUri);
                link.setAttribute('download', `session_${sessionId}_${new Date().getTime()}.json`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                addSystemMessage('Session data downloaded.');
            } catch (error) {
                console.error('Error downloading session:', error);
                alert('Error downloading session data.');
            }
        }

        async function deleteSession(sessionId) {
            if (!confirm('Delete this session and all its messages?')) return;
            
            try {
                // Delete messages first
                await supabase
                    .from('messages')
                    .delete()
                    .eq('session_id', sessionId);
                
                // Delete session
                await supabase
                    .from('sessions')
                    .delete()
                    .eq('session_id', sessionId);
                
                // Reload sessions
                loadSessions();
                
                // If viewing this session, go back to active
                if (appState.historicalSessionId === sessionId) {
                    returnToActiveChat();
                }
                
                addSystemMessage('Session deleted.');
            } catch (error) {
                console.error('Error deleting session:', error);
                alert('Error deleting session.');
            }
        }

        function returnToActiveChat() {
            appState.viewingHistory = false;
            appState.historicalSessionId = null;
            loadChatHistory();
            updateChatTitle();
        }

        async function loadPendingGuests() {
            if (!appState.isHost) return;
            
            try {
                const pending = await getPendingGuests();
                guestList.innerHTML = '';
                
                if (pending.length === 0) {
                    guestList.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">No pending guest requests.</p>';
                    return;
                }
                
                pending.forEach(guest => {
                    const guestDiv = document.createElement('div');
                    guestDiv.className = 'guest-item';
                    guestDiv.innerHTML = `
                        <div>
                            <strong>${guest.name}</strong><br>
                            <small>${new Date(guest.timestamp).toLocaleTimeString()}</small>
                        </div>
                        <div class="guest-actions">
                            <button class="btn btn-success btn-small" onclick="approveGuest('${guest.id}')">
                                <i class="fas fa-check"></i> Approve
                            </button>
                            <button class="btn btn-danger btn-small" onclick="rejectGuest('${guest.id}')">
                                <i class="fas fa-times"></i> Reject
                            </button>
                        </div>
                    `;
                    guestList.appendChild(guestDiv);
                });
            } catch (error) {
                console.error('Error loading pending guests:', error);
            }
        }

        async function approveGuest(guestId) {
            try {
                const guest = (await getPendingGuests()).find(g => g.id === guestId);
                if (!guest) return;
                
                await addGuestToSession();
                
                // Send notification message
                await saveMessageToDB('System', `${guest.name} has been approved and joined the chat.`);
                
                // Reload pending guests
                loadPendingGuests();
                
            } catch (error) {
                console.error('Error approving guest:', error);
            }
        }

        async function rejectGuest(guestId) {
            try {
                const pending = await getPendingGuests();
                const updatedPending = pending.filter(g => g.id !== guestId);
                
                await supabase
                    .from('sessions')
                    .update({ pending_guests: updatedPending })
                    .eq('session_id', appState.currentSessionId);
                
                loadPendingGuests();
            } catch (error) {
                console.error('Error rejecting guest:', error);
            }
        }

        function setupRealtimeSubscriptions() {
            // Remove existing subscriptions
            if (appState.realtimeSubscription) {
                supabase.removeChannel(appState.realtimeSubscription);
            }
            
            // Messages subscription
            appState.realtimeSubscription = supabase
                .channel(`chat-${appState.currentSessionId}`)
                .on('postgres_changes', {
                    event: 'INSERT',
                    schema: 'public',
                    table: 'messages',
                    filter: `session_id=eq.${appState.currentSessionId}`
                }, (payload) => {
                    if (payload.new.sender_id !== appState.userId) {
                        appState.messages.push(payload.new);
                        displayMessage(payload.new, 'received');
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                        
                        // Play sound if enabled
                        if (appState.soundEnabled && !appState.viewingHistory) {
                            messageSound.currentTime = 0;
                            messageSound.play().catch(e => console.log('Audio play failed:', e));
                        }
                    }
                })
                .on('postgres_changes', {
                    event: 'UPDATE',
                    schema: 'public',
                    table: 'sessions',
                    filter: `session_id=eq.${appState.currentSessionId}`
                }, (payload) => {
                    // Handle guest approvals
                    if (appState.isHost) {
                        loadPendingGuests();
                    } else {
                        // Check if guest was approved
                        const approvedGuests = payload.new.approved_guests || [];
                        if (approvedGuests.includes(appState.userId)) {
                            // Guest was approved, refresh UI
                            loadPendingGuests();
                        }
                    }
                })
                .subscribe();
        }

        function toggleSound() {
            appState.soundEnabled = !appState.soundEnabled;
            localStorage.setItem('writeToMe_sound', appState.soundEnabled);
            updateSoundButton();
        }

        function updateSoundButton() {
            const icon = soundToggle.querySelector('i');
            icon.className = appState.soundEnabled ? 'fas fa-volume-up' : 'fas fa-volume-mute';
        }

        function previewImage(src) {
            modalImage.src = src;
            imageModal.style.display = 'flex';
        }

        function generateUserId() {
            return 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function generateSessionId() {
            return 'session_' + Date.now().toString(36);
        }

        async function getRealIP() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip || "Unknown";
            } catch {
                return "Unknown";
            }
        }

        async function saveMessageToDB(senderName, messageText) {
            try {
                await supabase
                    .from('messages')
                    .insert([{
                        session_id: appState.currentSessionId,
                        sender_id: appState.userId,
                        sender_name: senderName,
                        message: messageText,
                        created_at: new Date().toISOString()
                    }]);
            } catch (error) {
                console.error("Error saving message:", error);
            }
        }

        // Make functions available globally for event handlers
        window.approveGuest = approveGuest;
        window.rejectGuest = rejectGuest;
        window.viewSessionHistory = viewSessionHistory;
        window.downloadSessionData = downloadSessionData;
        window.deleteSession = deleteSession;
        window.editMessage = editMessage;
        window.deleteMessage = deleteMessage;
        window.replyToMessage = replyToMessage;
        window.previewImage = previewImage;

        // Initialize app
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
