<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WriteToMe - Secure Chat</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        /* ... (keep all your existing CSS styles) ... */
    </style>
</head>
<body>
    <!-- Connection Modal -->
    <div id="connectionModal" class="connection-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-user-shield"></i> WriteToMe - Secure Connection</h2>
            </div>
            <div class="modal-body">
                <div class="login-form">
                    <div class="form-group">
                        <label for="userSelect"><i class="fas fa-user"></i> Select Role:</label>
                        <select id="userSelect" class="form-input">
                            <option value="guest">Guest</option>
                            <option value="host">Host</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="passwordInput"><i class="fas fa-lock"></i> Password:</label>
                        <input type="password" id="passwordInput" class="form-input" placeholder="Enter password">
                        <div id="passwordHint" class="password-hint"></div>
                    </div>
                    
                    <div id="passwordError" class="error-message">
                        Incorrect password for selected role.
                    </div>
                    
                    <div id="connectionError" class="error-message" style="display: none; color: #ff9800;">
                        Connection error. Check console for details.
                    </div>
                    
                    <button id="connectBtn" class="btn" style="width: 100%; margin-top: 20px;">
                        <i class="fas fa-plug"></i> Connect
                    </button>
                </div>
            </div>
        </div>
    </div>

    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-comment-alt"></i>
                    <h1>WriteToMe</h1>
                </div>
                <div class="header-controls">
                    <div class="user-status">
                        <div id="statusIndicator" class="status-indicator"></div>
                        <span id="userRoleDisplay">Disconnected</span>
                    </div>
                    <button id="logoutBtn" class="btn btn-secondary" style="display: none;">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="main-app">
            <!-- Chat Section -->
            <section class="chat-section">
                <div class="section-header">
                    <h2><i class="fas fa-comments"></i> Secure Chat</h2>
                    <div class="chat-controls">
                        <button id="refreshChatBtn" class="btn btn-secondary">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                        <button id="clearChatBtn" class="btn btn-danger">
                            <i class="fas fa-trash-alt"></i> Clear
                        </button>
                    </div>
                </div>
                
                <!-- Pending Guests Section (Host Only) -->
                <div id="pendingGuests" class="pending-guests" style="display: none;">
                    <h3><i class="fas fa-user-clock"></i> Pending Guests</h3>
                    <div id="guestList" class="guest-list"></div>
                </div>
                
                <div class="chat-messages" id="chatMessages">
                    <div class="message received">
                        <div class="message-sender">System</div>
                        <div>Welcome to WriteToMe! Connect to start chatting.</div>
                        <div class="message-time">Just now</div>
                    </div>
                </div>
                
                <div id="typingIndicator" class="typing-indicator">
                    <i class="fas fa-pencil-alt"></i> <span id="typingUser">User</span> is typing...
                </div>
                
                <div class="chat-input-area">
                    <input type="text" id="messageInput" class="chat-input" placeholder="Type your message here..." disabled>
                    <button id="sendMessageBtn" class="btn" disabled>
                        <i class="fas fa-paper-plane"></i> Send
                    </button>
                </div>
            </section>
        </div>

        <!-- Admin Panel (Host Only) -->
        <div class="admin-panel" id="adminPanel" style="display: none;">
            <div class="admin-header" id="adminToggle">
                <h3><i class="fas fa-user-secret"></i> Admin Panel</h3>
                <i class="fas fa-chevron-down"></i>
            </div>
            <div class="admin-content" id="adminContent">
                <div class="admin-info" id="adminInfo"></div>
                <div class="control-buttons">
                    <button id="refreshInfoBtn" class="btn">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
            </div>
        </div>
    </div>

    <footer>
        <div class="container">
            <p>WriteToMe &copy; 2023 - Secure Communication Platform</p>
        </div>
    </footer>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://plqvqenoroacvzwtgoxq.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_91IHQ5--y4tDIo8L9X2ZJQ_YeThfdu_';
        
        // Initialize Supabase
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // App State
        const appState = {
            isHost: false,
            isConnected: false,
            userName: '',
            userId: null,
            sessionId: null,
            messages: [],
            currentImage: null,
            typingTimeout: null,
            connectionTime: null,
            adminVisible: false,
            realtimeSubscription: null,
            pendingGuests: [],
            activeGuests: []
        };

        // DOM Elements
        const connectionModal = document.getElementById('connectionModal');
        const userSelect = document.getElementById('userSelect');
        const passwordInput = document.getElementById('passwordInput');
        const connectBtn = document.getElementById('connectBtn');
        const passwordError = document.getElementById('passwordError');
        const connectionError = document.getElementById('connectionError');
        const logoutBtn = document.getElementById('logoutBtn');
        const statusIndicator = document.getElementById('statusIndicator');
        const userRoleDisplay = document.getElementById('userRoleDisplay');
        const chatMessages = document.getElementById('chatMessages');
        const messageInput = document.getElementById('messageInput');
        const sendMessageBtn = document.getElementById('sendMessageBtn');
        const clearChatBtn = document.getElementById('clearChatBtn');
        const refreshChatBtn = document.getElementById('refreshChatBtn');
        const adminPanel = document.getElementById('adminPanel');
        const adminToggle = document.getElementById('adminToggle');
        const adminContent = document.getElementById('adminContent');
        const adminInfo = document.getElementById('adminInfo');
        const refreshInfoBtn = document.getElementById('refreshInfoBtn');
        const pendingGuestsDiv = document.getElementById('pendingGuests');
        const guestList = document.getElementById('guestList');

        // Debug function
        function debugLog(message, data = null) {
            console.log(`[DEBUG] ${message}`, data || '');
        }

        // Initialize App
        async function initApp() {
            debugLog("Initializing app...");
            
            // Check if Supabase is loaded
            if (!window.supabase) {
                debugLog("Supabase not loaded!");
                connectionError.textContent = "Error: Supabase library failed to load. Check network.";
                connectionError.style.display = 'block';
                return;
            }
            
            const savedSession = localStorage.getItem('writeToMe_session');
            if (savedSession) {
                try {
                    const sessionData = JSON.parse(savedSession);
                    appState.isHost = sessionData.isHost;
                    appState.userName = sessionData.userName;
                    appState.userId = sessionData.userId;
                    appState.sessionId = sessionData.sessionId;
                    
                    debugLog("Found saved session:", sessionData);
                    
                    if (await reconnectToSession()) {
                        appState.isConnected = true;
                        connectionModal.style.display = 'none';
                        updateUIAfterConnection();
                        loadChatHistory();
                        setupRealtimeSubscription();
                        debugLog("Reconnected successfully");
                    } else {
                        debugLog("Reconnection failed, clearing saved session");
                        localStorage.removeItem('writeToMe_session');
                        connectionModal.style.display = 'flex';
                    }
                } catch (e) {
                    debugLog("Error parsing saved session:", e);
                    localStorage.removeItem('writeToMe_session');
                    connectionModal.style.display = 'flex';
                }
            } else {
                debugLog("No saved session found");
                connectionModal.style.display = 'flex';
            }
            
            setupEventListeners();
            debugLog("App initialized");
        }

        // Event Listeners
        function setupEventListeners() {
            debugLog("Setting up event listeners");
            
            // Password hints
            passwordInput.addEventListener('focus', () => {
                const hint = document.getElementById('passwordHint');
                if (userSelect.value === 'host') {
                    hint.textContent = 'Hint: Host password is Mira4994Mira';
                    hint.style.display = 'block';
                } else {
                    hint.textContent = 'Hint: Guest password is LovingStrangers';
                    hint.style.display = 'block';
                }
            });
            
            passwordInput.addEventListener('blur', () => {
                document.getElementById('passwordHint').style.display = 'none';
            });
            
            userSelect.addEventListener('change', () => {
                passwordInput.value = '';
                passwordError.style.display = 'none';
                connectionError.style.display = 'none';
                passwordInput.focus();
            });
            
            // Connection
            connectBtn.addEventListener('click', handleConnect);
            passwordInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleConnect();
            });
            
            // Logout
            logoutBtn.addEventListener('click', handleLogout);
            
            // Chat
            messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessage();
            });
            sendMessageBtn.addEventListener('click', sendMessage);
            clearChatBtn.addEventListener('click', clearChat);
            refreshChatBtn.addEventListener('click', refreshMessages);
            
            // Admin Panel
            adminToggle.addEventListener('click', toggleAdminPanel);
            refreshInfoBtn.addEventListener('click', refreshAdminInfo);
        }

        // Handle Connection
        async function handleConnect() {
            debugLog("Handle connect started");
            
            // Disable connect button and show loading
            connectBtn.disabled = true;
            connectBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Connecting...';
            
            // Hide previous errors
            passwordError.style.display = 'none';
            connectionError.style.display = 'none';
            
            const selectedRole = userSelect.value;
            const password = passwordInput.value;
            
            // Validate password
            let isValid = false;
            if (selectedRole === 'host') {
                isValid = password === 'Mira4994Mira';
                appState.isHost = true;
                appState.userName = "Host";
            } else {
                isValid = password === 'LovingStrangers';
                appState.isHost = false;
                appState.userName = "Guest";
            }
            
            if (!isValid) {
                passwordError.style.display = 'block';
                passwordInput.focus();
                
                // Re-enable button
                connectBtn.disabled = false;
                connectBtn.innerHTML = '<i class="fas fa-plug"></i> Connect';
                return;
            }
            
            debugLog(`Password valid for ${selectedRole}, connecting...`);
            
            // Generate IDs
            appState.userId = generateUserId();
            appState.sessionId = generateSessionId();
            appState.connectionTime = new Date();
            
            debugLog(`Generated IDs - User: ${appState.userId}, Session: ${appState.sessionId}`);
            
            // Connect to database
            try {
                const connected = await connectToSupabase();
                
                if (connected) {
                    appState.isConnected = true;
                    
                    // Save session
                    localStorage.setItem('writeToMe_session', JSON.stringify({
                        isHost: appState.isHost,
                        userName: appState.userName,
                        userId: appState.userId,
                        sessionId: appState.sessionId,
                        connectionTime: appState.connectionTime
                    }));
                    
                    connectionModal.style.display = 'none';
                    updateUIAfterConnection();
                    
                    // Save IP (optional)
                    try {
                        const userIP = await getRealIP();
                        if (appState.isHost) {
                            await supabase.from('sessions').update({ host_ip: userIP }).eq('session_id', appState.sessionId);
                        } else {
                            await supabase.from('sessions').update({ guest_ip: userIP }).eq('session_id', appState.sessionId);
                        }
                    } catch (ipError) {
                        debugLog("Could not save IP:", ipError);
                    }
                    
                    // Add system message
                    await saveMessageToDB('System', `${appState.userName} has connected.`);
                    
                    // Setup real-time
                    setupRealtimeSubscription();
                    
                    // Show admin panel for host
                    if (appState.isHost) {
                        adminPanel.style.display = 'block';
                        refreshAdminInfo();
                    }
                    
                    debugLog("Connection successful!");
                } else {
                    throw new Error("Failed to connect to Supabase");
                }
            } catch (error) {
                debugLog("Connection error:", error);
                connectionError.textContent = `Connection error: ${error.message}`;
                connectionError.style.display = 'block';
                alert("Connection failed. Please check the console for details.");
            } finally {
                // Always re-enable button
                connectBtn.disabled = false;
                connectBtn.innerHTML = '<i class="fas fa-plug"></i> Connect';
            }
        }

        // SIMPLIFIED Connect to Supabase
        async function connectToSupabase() {
            try {
                debugLog("connectToSupabase called", { isHost: appState.isHost, sessionId: appState.sessionId });
                
                if (appState.isHost) {
                    // HOST: Create or find active session
                    debugLog("Host connecting...");
                    
                    // First, check for existing active sessions
                    const { data: existingSessions, error: checkError } = await supabase
                        .from('sessions')
                        .select('*')
                        .eq('is_active', true)
                        .order('created_at', { ascending: false })
                        .limit(1);
                    
                    if (checkError) {
                        debugLog("Error checking existing sessions:", checkError);
                        // Continue to create new session
                    }
                    
                    // If there's an active session, join it
                    if (existingSessions && existingSessions.length > 0) {
                        appState.sessionId = existingSessions[0].session_id;
                        debugLog("Joined existing session:", appState.sessionId);
                        return true;
                    }
                    
                    // Create new session
                    const sessionData = {
                        session_id: appState.sessionId,
                        host_id: appState.userId,
                        host_name: appState.userName,
                        is_active: true,
                        created_at: new Date().toISOString()
                    };
                    
                    debugLog("Creating new session with data:", sessionData);
                    
                    const { data, error } = await supabase
                        .from('sessions')
                        .insert([sessionData])
                        .select()
                        .single();
                    
                    if (error) {
                        debugLog("Error creating session:", error);
                        
                        // If session already exists, try to update it
                        if (error.code === '23505') { // Unique violation
                            debugLog("Session exists, updating...");
                            const { error: updateError } = await supabase
                                .from('sessions')
                                .update({
                                    host_id: appState.userId,
                                    host_name: appState.userName,
                                    is_active: true
                                })
                                .eq('session_id', appState.sessionId);
                            
                            if (updateError) {
                                debugLog("Error updating session:", updateError);
                                throw updateError;
                            }
                            return true;
                        }
                        throw error;
                    }
                    
                    debugLog("Session created successfully:", data);
                    return true;
                    
                } else {
                    // GUEST: Find active session
                    debugLog("Guest connecting...");
                    
                    const { data: sessions, error } = await supabase
                        .from('sessions')
                        .select('*')
                        .eq('is_active', true)
                        .order('created_at', { ascending: false })
                        .limit(1);
                    
                    if (error) {
                        debugLog("Error finding active sessions:", error);
                        throw error;
                    }
                    
                    if (!sessions || sessions.length === 0) {
                        alert("No active session found. Please ask the host to create a session first.");
                        return false;
                    }
                    
                    const session = sessions[0];
                    appState.sessionId = session.session_id;
                    debugLog("Found active session:", session.session_id);
                    
                    // Update session with guest info
                    const { error: updateError } = await supabase
                        .from('sessions')
                        .update({
                            guest_id: appState.userId,
                            guest_name: appState.userName,
                            guest_connected_at: new Date().toISOString()
                        })
                        .eq('session_id', appState.sessionId);
                    
                    if (updateError) {
                        debugLog("Error updating session with guest info:", updateError);
                        throw updateError;
                    }
                    
                    debugLog("Guest connected to session");
                    return true;
                }
            } catch (error) {
                debugLog("connectToSupabase error:", error);
                throw error;
            }
        }

        // Update UI after connection
        function updateUIAfterConnection() {
            debugLog("Updating UI after connection");
            
            statusIndicator.classList.add('connected');
            userRoleDisplay.textContent = `${appState.userName} (Connected)`;
            logoutBtn.style.display = 'flex';
            
            // Enable chat controls
            messageInput.disabled = false;
            sendMessageBtn.disabled = false;
            messageInput.placeholder = "Type your message here...";
            messageInput.focus();
            
            // Show pending guests section for host (if implemented)
            if (appState.isHost) {
                pendingGuestsDiv.style.display = 'block';
                // loadPendingGuests(); // Uncomment if you implement this
            }
            
            debugLog("UI updated successfully");
        }

        // Handle Logout
        async function handleLogout() {
            if (confirm("Are you sure you want to logout?")) {
                debugLog("Logging out...");
                
                localStorage.removeItem('writeToMe_session');
                
                if (appState.isConnected && appState.sessionId) {
                    try {
                        if (appState.isHost) {
                            await supabase
                                .from('sessions')
                                .update({ 
                                    is_active: false,
                                    ended_at: new Date().toISOString()
                                })
                                .eq('session_id', appState.sessionId);
                        }
                    } catch (error) {
                        debugLog("Error during logout:", error);
                    }
                }
                
                // Reset app state
                Object.keys(appState).forEach(key => {
                    if (typeof appState[key] === 'boolean') {
                        appState[key] = false;
                    } else if (Array.isArray(appState[key])) {
                        appState[key] = [];
                    } else {
                        appState[key] = null;
                    }
                });
                
                appState.userName = "Guest";
                appState.isHost = false;
                
                // Reset UI
                statusIndicator.classList.remove('connected');
                userRoleDisplay.textContent = "Disconnected";
                logoutBtn.style.display = 'none';
                messageInput.disabled = true;
                sendMessageBtn.disabled = true;
                messageInput.value = '';
                chatMessages.innerHTML = '<div class="message received"><div class="message-sender">System</div><div>Welcome to WriteToMe! Connect to start chatting.</div><div class="message-time">Just now</div></div>';
                adminPanel.style.display = 'none';
                pendingGuestsDiv.style.display = 'none';
                
                connectionModal.style.display = 'flex';
                debugLog("Logout complete");
            }
        }

        // Send Message
        async function sendMessage() {
            const messageText = messageInput.value.trim();
            if (!messageText) return;
            
            const message = {
                id: Date.now(),
                sender: appState.userName,
                text: messageText,
                time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                type: 'sent'
            };
            
            appState.messages.push(message);
            displayMessage(message);
            messageInput.value = '';
            messageInput.focus();
            
            await saveMessageToDB(appState.userName, messageText);
        }

        // Display Message
        function displayMessage(message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${message.type}`;
            messageDiv.innerHTML = `
                <div class="message-sender">${message.sender}</div>
                <div>${message.text}</div>
                <div class="message-time">${message.time}</div>
            `;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Save Message to DB
        async function saveMessageToDB(senderName, messageText) {
            try {
                debugLog("Saving message to DB");
                
                // First, make sure we have a messages table
                const messageData = {
                    session_id: appState.sessionId,
                    sender_id: appState.userId,
                    sender_name: senderName,
                    message: messageText,
                    created_at: new Date().toISOString()
                };
                
                debugLog("Message data:", messageData);
                
                const { error } = await supabase
                    .from('messages')
                    .insert([messageData]);
                
                if (error) {
                    debugLog("Error saving message:", error);
                    
                    // If messages table doesn't exist, create it in local storage as fallback
                    const localMessages = JSON.parse(localStorage.getItem('writeToMe_messages') || '{}');
                    if (!localMessages[appState.sessionId]) {
                        localMessages[appState.sessionId] = [];
                    }
                    localMessages[appState.sessionId].push(messageData);
                    localStorage.setItem('writeToMe_messages', JSON.stringify(localMessages));
                    debugLog("Message saved to local storage as fallback");
                } else {
                    debugLog("Message saved to Supabase");
                }
            } catch (error) {
                debugLog("Error in saveMessageToDB:", error);
            }
        }

        // Load Chat History
        async function loadChatHistory() {
            try {
                debugLog("Loading chat history for session:", appState.sessionId);
                
                const { data: messages, error } = await supabase
                    .from('messages')
                    .select('*')
                    .eq('session_id', appState.sessionId)
                    .order('created_at', { ascending: true });
                
                if (error) {
                    debugLog("Error loading messages from Supabase:", error);
                    
                    // Fallback to local storage
                    const localMessages = JSON.parse(localStorage.getItem('writeToMe_messages') || '{}');
                    messages = localMessages[appState.sessionId] || [];
                    debugLog("Loaded messages from local storage:", messages.length);
                }
                
                chatMessages.innerHTML = '';
                appState.messages = [];
                
                if (messages && messages.length > 0) {
                    messages.forEach(msg => {
                        const messageType = msg.sender_id === appState.userId ? 'sent' : 'received';
                        displayMessage({
                            id: msg.id,
                            sender: msg.sender_name,
                            text: msg.message,
                            time: new Date(msg.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                            type: messageType
                        });
                    });
                    debugLog(`Displayed ${messages.length} messages`);
                } else {
                    // Show welcome message
                    const welcomeDiv = document.createElement('div');
                    welcomeDiv.className = 'message received';
                    welcomeDiv.innerHTML = `
                        <div class="message-sender">System</div>
                        <div>Welcome to the chat! Start sending messages.</div>
                        <div class="message-time">Just now</div>
                    `;
                    chatMessages.appendChild(welcomeDiv);
                    debugLog("No messages found, showing welcome");
                }
            } catch (error) {
                debugLog("Error loading chat history:", error);
                alert("Error loading chat history. Check console.");
            }
        }

        // Setup Realtime Subscription
        function setupRealtimeSubscription() {
            debugLog("Setting up realtime subscription");
            
            if (appState.realtimeSubscription) {
                supabase.removeChannel(appState.realtimeSubscription);
            }
            
            // Subscribe to new messages
            appState.realtimeSubscription = supabase
                .channel(`chat-${appState.sessionId}`)
                .on('postgres_changes', {
                    event: 'INSERT',
                    schema: 'public',
                    table: 'messages',
                    filter: `session_id=eq.${appState.sessionId}`
                }, (payload) => {
                    debugLog("New message received:", payload.new);
                    
                    if (payload.new.sender_id !== appState.userId) {
                        displayMessage({
                            id: payload.new.id,
                            sender: payload.new.sender_name,
                            text: payload.new.message,
                            time: new Date(payload.new.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                            type: 'received'
                        });
                    }
                })
                .subscribe((status) => {
                    debugLog("Realtime subscription status:", status);
                });
        }

        // Clear Chat
        async function clearChat() {
            if (confirm("Are you sure you want to clear all chat messages?")) {
                try {
                    if (appState.isHost) {
                        // Host can clear from database
                        const { error } = await supabase
                            .from('messages')
                            .delete()
                            .eq('session_id', appState.sessionId);
                        
                        if (error) {
                            debugLog("Error clearing messages from DB:", error);
                            // Fallback to local
                            const localMessages = JSON.parse(localStorage.getItem('writeToMe_messages') || '{}');
                            delete localMessages[appState.sessionId];
                            localStorage.setItem('writeToMe_messages', JSON.stringify(localMessages));
                        }
                    }
                    
                    // Clear local view
                    const localMessages = JSON.parse(localStorage.getItem('writeToMe_messages') || '{}');
                    delete localMessages[appState.sessionId];
                    localStorage.setItem('writeToMe_messages', JSON.stringify(localMessages));
                    
                    chatMessages.innerHTML = '';
                    appState.messages = [];
                    
                    // Add system message
                    const systemDiv = document.createElement('div');
                    systemDiv.className = 'message received';
                    systemDiv.innerHTML = `
                        <div class="message-sender">System</div>
                        <div>Chat cleared.</div>
                        <div class="message-time">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                    `;
                    chatMessages.appendChild(systemDiv);
                    
                } catch (error) {
                    debugLog("Error clearing chat:", error);
                    alert("Error clearing chat.");
                }
            }
        }

        // Refresh Messages
        async function refreshMessages() {
            await loadChatHistory();
            
            // Add system message
            const systemDiv = document.createElement('div');
            systemDiv.className = 'message received';
            systemDiv.innerHTML = `
                <div class="message-sender">System</div>
                <div>Messages refreshed.</div>
                <div class="message-time">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
            `;
            chatMessages.appendChild(systemDiv);
        }

        // Refresh Admin Info
        async function refreshAdminInfo() {
            try {
                const { data: sessions, error } = await supabase
                    .from('sessions')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(10);
                
                if (error) throw error;
                
                let sessionsHTML = '';
                
                if (sessions && sessions.length > 0) {
                    for (const session of sessions) {
                        const isActive = session.is_active;
                        const isCurrent = session.session_id === appState.sessionId;
                        
                        sessionsHTML += `
                            <div class="info-card ${isCurrent ? 'current-session' : ''}">
                                <h4>
                                    <i class="fas fa-comments"></i> Session
                                    ${isActive ? '<span class="active-badge">ACTIVE</span>' : ''}
                                    ${isCurrent ? '<span class="current-badge">CURRENT</span>' : ''}
                                </h4>
                                <p><strong>Host:</strong> ${session.host_name || 'N/A'}</p>
                                <p><strong>Guest:</strong> ${session.guest_name || 'Not connected'}</p>
                                <p><strong>Started:</strong> ${new Date(session.created_at).toLocaleString()}</p>
                                <p><strong>Status:</strong> ${isActive ? 'Active' : 'Ended'}</p>
                            </div>
                        `;
                    }
                } else {
                    sessionsHTML = '<p>No sessions found.</p>';
                }
                
                adminInfo.innerHTML = sessionsHTML;
            } catch (error) {
                debugLog("Error loading admin info:", error);
                adminInfo.innerHTML = `<p class="error">Error loading sessions: ${error.message}</p>`;
            }
        }

        // Helper Functions
        function generateUserId() {
            return 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function generateSessionId() {
            return 'session_' + Date.now().toString(36);
        }

        async function getRealIP() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip || "Unknown";
            } catch {
                return "Unknown";
            }
        }

        async function reconnectToSession() {
            try {
                debugLog("Attempting to reconnect to session:", appState.sessionId);
                
                const { data: session, error } = await supabase
                    .from('sessions')
                    .select('*')
                    .eq('session_id', appState.sessionId)
                    .single();
                
                if (error || !session) {
                    debugLog("Session not found or error:", error);
                    return false;
                }
                
                if (!session.is_active) {
                    debugLog("Session is not active");
                    return false;
                }
                
                if (appState.isHost) {
                    const reconnected = session.host_id === appState.userId;
                    debugLog("Host reconnection result:", reconnected);
                    return reconnected;
                } else {
                    const reconnected = session.guest_id === appState.userId;
                    debugLog("Guest reconnection result:", reconnected);
                    return reconnected;
                }
            } catch (error) {
                debugLog("Reconnection error:", error);
                return false;
            }
        }

        function addSystemMessage(text) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message received';
            messageDiv.innerHTML = `
                <div class="message-sender">System</div>
                <div>${text}</div>
                <div class="message-time">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
            `;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function toggleAdminPanel() {
            appState.adminVisible = !appState.adminVisible;
            adminContent.classList.toggle('show', appState.adminVisible);
            
            const chevron = adminToggle.querySelector('i');
            chevron.className = appState.adminVisible ? 'fas fa-chevron-up' : 'fas fa-chevron-down';
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', initApp);
        
        // Expose appState for debugging
        window.debugApp = () => {
            console.log("App State:", appState);
            console.log("Local Storage:", localStorage.getItem('writeToMe_session'));
            return appState;
        };
    </script>
</body>
</html>
