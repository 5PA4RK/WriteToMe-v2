<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WriteToMe - Secure Chat</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
:root {
    --dark-bg: #2a2a2a;          /* Even lighter grey */
    --darker-bg: #333333;        /* Medium grey */
    --card-bg: #3a3a3a;          /* Light grey cards */
    --border-color: #555;        /* Medium grey borders */
    --text-primary: #f8f8f8;     /* Very light text */
    --text-secondary: #dddddd;   /* Light grey text */
    --accent-orange: #ff9800;    /* Unchanged */
    --accent-orange-dark: #e68900; /* Unchanged */
    --success-green: #4caf50;    /* Unchanged */
    --danger-red: #f44336;       /* Unchanged */
    --warning-yellow: #ffc107;   /* Unchanged */
}

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--dark-bg);
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            width: 100%;
        }

        header {
            background-color: var(--darker-bg);
            padding: 20px;
            border-bottom: 2px solid var(--accent-orange);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo i {
            color: var(--accent-orange);
            font-size: 32px;
        }

        .logo h1 {
            font-size: 28px;
            color: var(--accent-orange);
            letter-spacing: 1px;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-status {
            display: flex;
            align-items: center;
            gap: 10px;
            background-color: var(--card-bg);
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: var(--success-green);
        }

        .status-indicator.offline {
            background-color: var(--danger-red);
        }

        .main-app {
            display: flex;
            flex-direction: column;
            gap: 25px;
            padding: 25px 0;
        }

        @media (min-width: 992px) {
            .main-app {
                flex-direction: row;
            }
        }

        .chat-section, .image-section {
            background-color: var(--card-bg);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            overflow: hidden;
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
        }

        .chat-section {
            flex: 2;
        }

        .image-section {
            flex: 1;
        }

        .section-header {
            background-color: var(--darker-bg);
            padding: 18px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-header h2 {
            color: var(--accent-orange);
            font-size: 22px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chat-messages {
            height: 400px;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 18px;
            position: relative;
            line-height: 1.4;
        }

        .message.sent {
            align-self: flex-end;
            background-color: var(--accent-orange);
            color: var(--darker-bg);
            border-bottom-right-radius: 5px;
        }

.message.received {
    align-self: flex-start;
    background-color: #555555;  /* Medium grey (was #333) */
    color: var(--text-primary);
    border-bottom-left-radius: 5px;
}

        .message-sender {
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 5px;
            color: var(--accent-orange-dark);
        }

        .message.sent .message-sender {
            color: #000;
        }

        .message-time {
            font-size: 11px;
            text-align: right;
            margin-top: 5px;
            opacity: 0.8;
        }

        .chat-input-area {
            padding: 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 14px 18px;
            background-color: var(--darker-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 16px;
            outline: none;
            transition: border-color 0.3s;
        }

        .chat-input:focus {
            border-color: var(--accent-orange);
        }

        .btn {
            padding: 14px 24px;
            background-color: var(--accent-orange);
            color: var(--darker-bg);
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn:hover {
            background-color: var(--accent-orange-dark);
            transform: translateY(-2px);
        }

        .btn-danger {
            background-color: var(--danger-red);
            color: white;
        }

        .btn-danger:hover {
            background-color: #d32f2f;
        }

        .btn-secondary {
            background-color: var(--border-color);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background-color: #444;
        }

        .image-container {
            height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

.image-placeholder {
    width: 100%;
    height: 100%;
    background-color: #3a3a3a;  /* Medium grey (was #0a0a0a) */
    border: 2px dashed #666666; /* Light grey border */
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .image-placeholder:hover {
            border-color: var(--accent-orange);
            color: var(--accent-orange);
        }

        .image-placeholder i {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .image-preview {
            max-width: 100%;
            max-height: 100%;
            border-radius: 8px;
            object-fit: contain;
        }

        .image-controls {
            padding: 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .image-url-input {
            width: 100%;
            padding: 12px 16px;
            background-color: var(--darker-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            outline: none;
            transition: border-color 0.3s;
        }

        .image-url-input:focus {
            border-color: var(--accent-orange);
        }

        .control-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .control-buttons .btn {
            flex: 1;
            min-width: 120px;
        }

        .admin-panel {
            margin-top: 30px;
            background-color: var(--card-bg);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            overflow: hidden;
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
        }

.admin-header {
    background-color: #555555;  /* Darker grey (was #f44336 red) */
    padding: 15px 20px;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

        .admin-content {
            padding: 20px;
            display: none;
        }

        .admin-content.show {
            display: block;
        }

        .admin-info {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

.info-card {
    background-color: #333333;  /* Lighter: was var(--darker-bg) */
    padding: 15px;
    border-radius: 8px;
    border-left: 4px solid var(--accent-orange);
}

        .info-card h4 {
            color: var(--accent-orange);
            margin-bottom: 10px;
            font-size: 16px;
        }

        .info-card p {
            font-family: monospace;
            font-size: 14px;
            word-break: break-all;
        }

        .connection-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: var(--card-bg);
            width: 90%;
            max-width: 500px;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--accent-orange);
        }

        .modal-header {
            background-color: var(--darker-bg);
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-header h2 {
            color: var(--accent-orange);
        }

        .modal-body {
            padding: 30px;
        }

        .role-selection {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 25px;
        }

        .role-option {
            padding: 15px;
            background-color: var(--darker-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .role-option:hover {
            border-color: var(--accent-orange);
            transform: translateY(-3px);
        }

        .role-option.selected {
            border-color: var(--accent-orange);
            background-color: rgba(255, 152, 0, 0.1);
        }

        .role-icon {
            font-size: 24px;
            color: var(--accent-orange);
        }

        .password-input {
            width: 100%;
            padding: 14px 18px;
            background-color: var(--darker-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 16px;
            margin-top: 10px;
            outline: none;
            transition: border-color 0.3s;
        }

        .password-input:focus {
            border-color: var(--accent-orange);
        }

        .error-message {
            color: var(--danger-red);
            font-size: 14px;
            margin-top: 10px;
            display: none;
        }

        footer {
            margin-top: auto;
            padding: 20px;
            text-align: center;
            color: var(--text-secondary);
            font-size: 14px;
            border-top: 1px solid var(--border-color);
        }

        .typing-indicator {
            padding: 10px 20px;
            font-style: italic;
            color: var(--accent-orange);
            display: none;
        }

        .typing-indicator.show {
            display: block;
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--darker-bg);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-orange);
        }
        .login-form {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.form-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.form-group label {
    color: var(--text-primary);
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
}

.form-input {
    width: 100%;
    padding: 14px 18px;
    background-color: var(--darker-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    color: var(--text-primary);
    font-size: 16px;
    outline: none;
    transition: border-color 0.3s;
}

.form-input:focus {
    border-color: var(--accent-orange);
}

select.form-input {
    cursor: pointer;
}

.password-hint {
    font-size: 12px;
    color: var(--text-secondary);
    margin-top: 4px;
    font-style: italic;
}
/* Admin panel enhancements */
.current-session {
    border-left: 4px solid var(--success-green) !important;
    background-color: rgba(76, 175, 80, 0.1);
}

.active-badge {
    background-color: var(--success-green);
    color: white;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 12px;
    margin-left: 10px;
}

.current-badge {
    background-color: var(--accent-orange);
    color: var(--darker-bg);
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 12px;
    margin-left: 10px;
}

.btn-small {
    padding: 8px 16px !important;
    font-size: 14px !important;
    margin-top: 10px;
}

.session-history-modal {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background-color: var(--card-bg);
    padding: 20px;
    border-radius: 12px;
    border: 2px solid var(--accent-orange);
    max-width: 600px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
    z-index: 2000;
}

.history-messages {
    max-height: 400px;
    overflow-y: auto;
    margin: 20px 0;
}
/* Historical mode styling */
.historical-message {
    opacity: 0.8;
    border-left: 3px solid var(--warning-yellow) !important;
}

.readonly-input {
    background-color: #444 !important;
    cursor: not-allowed !important;
}

.historical-badge {
    background-color: var(--warning-yellow);
    color: #000;
    padding: 3px 10px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: bold;
    margin-left: 10px;
}

.chat-controls {
    display: flex;
    gap: 10px;
    align-items: center;
}
.chat-input-with-upload {
    flex: 1;
    display: flex;
    gap: 10px;
    align-items: center;
}

.image-upload-buttons {
    display: flex;
    gap: 5px;
}

.image-upload-buttons .btn {
    padding: 14px;
    width: 50px;
}

/* Image message styling */
.message-image {
    max-width: 300px;
    max-height: 300px;
    border-radius: 8px;
    margin-top: 5px;
    cursor: pointer;
    transition: transform 0.2s;
}

.message-image:hover {
    transform: scale(1.02);
}

.image-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.9);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 2000;
    cursor: pointer;
}

.image-modal img {
    max-width: 90%;
    max-height: 90%;
    border-radius: 8px;
    box-shadow: 0 0 30px rgba(0, 0, 0, 0.5);
}

.image-message-container {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
}

.image-caption {
    font-size: 12px;
    color: var(--text-secondary);
    margin-top: 5px;
    font-style: italic;
}

    </style>
</head>
<body>
    <!-- Connection Modal -->
    <div id="connectionModal" class="connection-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-user-shield"></i> WriteToMe - Secure Connection</h2>
            </div>
            <div class="modal-body">
                <div class="login-form">
                    <div class="form-group">
                        <label for="userSelect"><i class="fas fa-user"></i> Select Role:</label>
                        <select id="userSelect" class="form-input">
                            <option value="guest">Guest</option>
                            <option value="host">Host</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="passwordInput"><i class="fas fa-lock"></i> Password:</label>
                        <input type="password" id="passwordInput" class="form-input" placeholder="Enter password">
                        <div class="password-hint" id="passwordHint">
                            
                        </div>
                    </div>
                    
                    <div id="passwordError" class="error-message" style="display: none;">
                        Incorrect password for selected role.
                    </div>
                    
                    <button id="connectBtn" class="btn" style="width: 100%; margin-top: 20px;">
                        <i class="fas fa-plug"></i> Connect
                    </button>
                </div>
            </div>
        </div>
    </div>

    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-comment-alt"></i>
                    <h1>WriteToMe</h1>
                </div>
                <div class="header-controls">
                    <div class="user-status">
                        <div id="statusIndicator" class="status-indicator offline"></div>
                        <span id="userRoleDisplay">Disconnected</span>
                    </div>
                    <button id="logoutBtn" class="btn btn-secondary" style="display: none;">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="main-app">
            <!-- Chat Section -->
            <section class="chat-section">
                <div class="section-header">
                    <h2><i class="fas fa-comments"></i> Secure Chat</h2>
                    <div class="chat-controls">
                        <button id="refreshChatBtn" class="btn btn-secondary" style="margin-right: 10px;">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                        <button id="clearChatBtn" class="btn btn-danger">
                            <i class="fas fa-trash-alt"></i> Clear Chat
                        </button>
                    </div>
                </div>
                <div class="chat-messages" id="chatMessages">
                    <!-- Messages will appear here -->
                    <div class="message received">
                        <div class="message-sender">System</div>
                        <div>Welcome to WriteToMe! This is a secure chat room for two people only.</div>
                        <div class="message-time">Just now</div>
                    </div>
                </div>
                <div id="typingIndicator" class="typing-indicator">
                    <i class="fas fa-pencil-alt"></i> <span id="typingUser">User</span> is typing...
                </div>
                <div class="chat-input-area">
                    <div class="chat-input-with-upload">
                        <input type="text" id="messageInput" class="chat-input" placeholder="Type your message here..." disabled>
                        <div class="image-upload-buttons">
                            <button id="uploadImageBtn" class="btn btn-secondary" title="Upload Image">
                                <i class="fas fa-image"></i>
                            </button>
                            <input type="file" id="fileInput" accept="image/*" style="display: none;">
                        </div>
                    </div>
                    <button id="sendMessageBtn" class="btn" disabled>
                        <i class="fas fa-paper-plane"></i> Send
                    </button>
                </div>
            </section>

        <!-- Admin Panel (Hidden by default, only visible to Host) -->
        <div class="admin-panel" id="adminPanel" style="display: none;">
            <div class="admin-header" id="adminToggle">
                <h3><i class="fas fa-user-secret"></i> Admin Panel - Connected Users Information</h3>
                <i class="fas fa-chevron-down"></i>
            </div>
            <div class="admin-content" id="adminContent">
                <div class="admin-info" id="adminInfo">
                    <!-- Admin info will be populated here -->
                </div>
                <button id="refreshInfoBtn" class="btn">
                    <i class="fas fa-sync-alt"></i> Refresh Information
                </button>
            </div>
        </div>
    </div>

    <footer>
        <div class="container">
            <p>WriteToMe &copy; 2023 - Secure Two-Person Communication Platform | End-to-End Encrypted</p>
        </div>
    </footer>

    <!-- Hidden file input for image upload -->
    <input type="file" id="fileInput" accept="image/*" style="display: none;">

    <script>
        // Supabase Configuration - REPLACE WITH YOUR OWN CREDENTIALS
        const SUPABASE_URL = 'https://plqvqenoroacvzwtgoxq.supabase.co'; // Supabase URL
        const SUPABASE_ANON_KEY = 'sb_publishable_91IHQ5--y4tDIo8L9X2ZJQ_YeThfdu_'; //  Supabase anon key
        
        // Initialize Supabase client
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // App State
// App State
const appState = {
    isHost: false,
    isConnected: false,
    userName: "Guest",
    otherUserName: "Host",
    userId: null,
    sessionId: null,
    messages: [],
    currentImage: null,
    typingTimeout: null,
    connectionTime: null,
    adminVisible: false,
    realtimeSubscription: null,
    
    // ADD THESE 3 LINES (copy and paste exactly):
    isHistoricalView: false,
    viewingSessionId: null,
    viewingSessionName: ''
};

        // DOM Elements
        const connectionModal = document.getElementById('connectionModal');
        const connectBtn = document.getElementById('connectBtn');
        const passwordError = document.getElementById('passwordError');
        const logoutBtn = document.getElementById('logoutBtn');
        
        const statusIndicator = document.getElementById('statusIndicator');
        const userRoleDisplay = document.getElementById('userRoleDisplay');
        const currentUserSpan = document.getElementById('currentUser');
        
        const chatMessages = document.getElementById('chatMessages');
        const messageInput = document.getElementById('messageInput');
        const sendMessageBtn = document.getElementById('sendMessageBtn');
        const clearChatBtn = document.getElementById('clearChatBtn');
        
        const imagePlaceholder = document.getElementById('imagePlaceholder');
        const imagePreview = document.getElementById('imagePreview');
        const fileInput = document.getElementById('fileInput');
        const imageUrlInput = document.getElementById('imageUrlInput');
        const uploadImageBtn = document.getElementById('uploadImageBtn');
        const downloadImageBtn = document.getElementById('downloadImageBtn');
        const clearImageBtn = document.getElementById('clearImageBtn');
        
        const adminPanel = document.getElementById('adminPanel');
        const adminToggle = document.getElementById('adminToggle');
        const adminContent = document.getElementById('adminContent');
        const adminInfo = document.getElementById('adminInfo');
        const refreshInfoBtn = document.getElementById('refreshInfoBtn');
        
        const typingIndicator = document.getElementById('typingIndicator');
        const typingUser = document.getElementById('typingUser');

// Load a historical session into the main chat window
async function loadSessionIntoMainChat(sessionId, sessionName) {
    try {
        // Update app state
        appState.isHistoricalView = true;
        appState.viewingSessionId = sessionId;
        appState.viewingSessionName = sessionName;
        
        // Update UI to show historical mode
        document.querySelector('.section-header h2').innerHTML = 
            `<i class="fas fa-history"></i> Historical Chat: ${sessionName}`;
        
        // Disable real-time features
        messageInput.disabled = true;
        sendMessageBtn.disabled = true;
        messageInput.placeholder = "Historical chat - Read only";
        
        // Disable image sharing
        uploadImageBtn.disabled = true;
        imageUrlInput.disabled = true;
        clearImageBtn.disabled = true;
        
        // Change status indicator
        statusIndicator.style.backgroundColor = 'var(--warning-yellow)';
        userRoleDisplay.innerHTML = `<i class="fas fa-history"></i> Viewing History`;
        
        // Add a "Back to Live Chat" button
        if (!document.getElementById('backToLiveBtn')) {
            const backBtn = document.createElement('button');
            backBtn.id = 'backToLiveBtn';
            backBtn.className = 'btn';
            backBtn.innerHTML = '<i class="fas fa-arrow-left"></i> Back to Live Chat';
            backBtn.style.marginLeft = '10px';
            backBtn.onclick = returnToLiveChat;
            
            document.querySelector('.section-header').appendChild(backBtn);
        }
        
        // Load historical messages
        const { data: messages, error } = await supabaseClient
            .from('messages')
            .select('*')
            .eq('session_id', sessionId)
            .order('created_at', { ascending: true });
        
        if (error) throw error;
        
        // Clear current chat
        chatMessages.innerHTML = '';
        
        // Display historical messages
        messages.forEach(msg => {
            // For historical view, show all messages (no clearance filtering)
            const messageType = msg.sender_name === 'Host' ? 'sent' : 'received';
            displayMessage({
                id: msg.id,
                sender: msg.sender_name,
                text: msg.message,
                time: new Date(msg.created_at).toLocaleString([], { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    day: 'numeric',
                    month: 'short'
                }),
                type: messageType
            });
        });
        
        // Add info message at top
        const infoMsg = document.createElement('div');
        infoMsg.className = 'message received';
        infoMsg.innerHTML = `
            <div class="message-sender">System</div>
            <div><i class="fas fa-info-circle"></i> Viewing historical chat session. No new messages can be sent.</div>
            <div class="message-time">Just now</div>
        `;
        chatMessages.prepend(infoMsg);
        
    } catch (error) {
        console.error("Error loading historical chat:", error);
        alert("Error loading historical chat.");
        returnToLiveChat(); // Return to live on error
    }
}

// Return to live chat
async function returnToLiveChat() {
    // Reset app state
    appState.isHistoricalView = false;
    appState.viewingSessionId = null;
    appState.viewingSessionName = '';
    
    // Restore original UI
    document.querySelector('.section-header h2').innerHTML = 
        `<i class="fas fa-comments"></i> Secure Chat`;
    
    // Remove back button
    const backBtn = document.getElementById('backToLiveBtn');
    if (backBtn) backBtn.remove();
    
    // Restore real-time features if connected
    if (appState.isConnected) {
        messageInput.disabled = false;
        sendMessageBtn.disabled = false;
        messageInput.placeholder = "Type your message here...";
        messageInput.focus();
        
        uploadImageBtn.disabled = false;
        imageUrlInput.disabled = false;
        clearImageBtn.disabled = !appState.currentImage;
        
        // Restore status
        statusIndicator.style.backgroundColor = 'var(--success-green)';
        userRoleDisplay.textContent = `${appState.userName} (Connected)`;
        
        // Reload current chat
        loadChatHistory();
    } else {
        // Not connected - show empty chat
        chatMessages.innerHTML = '<div class="message received"><div class="message-sender">System</div><div>Welcome to WriteToMe! This is a secure chat room for two people only.</div><div class="message-time">Just now</div></div>';
        
        statusIndicator.classList.add('offline');
        userRoleDisplay.textContent = "Disconnected";
    }
}

        // Initialize the app
        async function initApp() {
            // Check if user was previously connected
            const savedSession = localStorage.getItem('writeToMe_session');
            if (savedSession) {
                const sessionData = JSON.parse(savedSession);
                appState.isHost = sessionData.isHost;
                appState.userName = sessionData.userName;
                appState.userId = sessionData.userId;
                appState.sessionId = sessionData.sessionId;
                appState.isConnected = true;
                
                // Try to reconnect to the session
                if (await reconnectToSession()) {
                    connectionModal.style.display = 'none';
                    updateUIAfterConnection();
                    loadChatHistory();
                    loadCurrentImage();
                } else {
                    // Session expired or invalid
                    localStorage.removeItem('writeToMe_session');
                    connectionModal.style.display = 'flex';
                }
            } else {
                connectionModal.style.display = 'flex';
            }

            // Set up event listeners
            setupEventListeners();
        }

        // Set up all event listeners
 // Set up all event listeners
function setupEventListeners() {
    // Connection modal - NEW CODE
    const userSelect = document.getElementById('userSelect');
    const passwordInput = document.getElementById('passwordInput');
    const connectBtn = document.getElementById('connectBtn');
    const passwordHint = document.getElementById('passwordHint');

    // Update password hint when role changes
    if (userSelect) {
        userSelect.addEventListener('change', function() {
            if (this.value === 'host') {
                passwordHint.textContent = '';
            } else {
                passwordHint.textContent = '';
            }
            // Clear any error
            document.getElementById('passwordError').style.display = 'none';
        });
    }

    // Allow Enter key in password field
    if (passwordInput) {
        passwordInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleConnect();
        });
    }

    // Connect button
    if (connectBtn) {
        connectBtn.addEventListener('click', handleConnect);
    }

        // ADD THIS LINE FOR LOGOUT:
    if (logoutBtn) {
        logoutBtn.addEventListener('click', handleLogout);
    }

    // Chat functionality
    messageInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendMessage();
    });
    messageInput.addEventListener('input', handleTyping);
    sendMessageBtn.addEventListener('click', sendMessage);
    clearChatBtn.addEventListener('click', clearChat);

    // ADD THIS LINE HERE:
    if (document.getElementById('refreshChatBtn')) {
    document.getElementById('refreshChatBtn').addEventListener('click', refreshMessages);
    console.log("âœ… Refresh button listener added");
} else {
    console.error("âŒ Refresh button not found!");
}

// Image functionality (integrated into chat)
document.getElementById('uploadImageBtn').addEventListener('click', () => {
    document.getElementById('fileInput').click();
});

document.getElementById('fileInput').addEventListener('change', handleFileSelect);

// Allow drag & drop images onto chat area
chatMessages.addEventListener('dragover', (e) => {
    e.preventDefault();
    chatMessages.style.backgroundColor = 'rgba(255, 152, 0, 0.1)';
});

chatMessages.addEventListener('dragleave', () => {
    chatMessages.style.backgroundColor = '';
});

chatMessages.addEventListener('drop', handleImageDrop);

// Keyboard shortcut for image upload (Ctrl+I or Cmd+I)
document.addEventListener('keydown', (e) => {
    if ((e.ctrlKey || e.metaKey) && e.key === 'i') {
        e.preventDefault();
        document.getElementById('fileInput').click();
    }
});

            // Admin panel
            adminToggle.addEventListener('click', toggleAdminPanel);
            refreshInfoBtn.addEventListener('click', refreshAdminInfo);
        }

// Handle connection
async function handleConnect() {
    // Get elements (already declared in setupEventListeners, but we need them here)
    const userSelect = document.getElementById('userSelect');
    const passwordInput = document.getElementById('passwordInput');
    
    const selectedRole = userSelect.value; // 'guest' or 'host'
    const password = passwordInput.value;
    
    // Reset error
    passwordError.style.display = 'none';
    
    // Validate password based on role
    let isValid = false;
    if (selectedRole === 'host') {
        isValid = password === 'Mira4994Mira';
        appState.isHost = true;
        appState.userName = "Host";
    } else { // guest
        isValid = password === 'LovingStrangers';
        appState.isHost = false;
        appState.userName = "Guest";
    }
    
    if (!isValid) {
        passwordError.style.display = 'block';
        passwordInput.focus();
        return;
    }
    
    // Generate unique user ID and session ID
    appState.userId = generateUserId();
    appState.sessionId = generateSessionId();
    appState.connectionTime = new Date();
    
    // Connect to Supabase
    if (await connectToSupabase()) {
        appState.isConnected = true;

        try {
        // Get real IP
        const userIP = await getRealIP();
        console.log("Detected user IP:", userIP);
        
        // Save IP to database based on role
        if (appState.isHost) {
            await supabaseClient
                .from('sessions')
                .update({ host_ip: userIP })
                .eq('session_id', appState.sessionId);
        } else {
            await supabaseClient
                .from('sessions')
                .update({ guest_ip: userIP })
                .eq('session_id', appState.sessionId);
        }
    } catch (ipError) {
        console.error("Error saving IP to database:", ipError);
    }
        
        // Save session to localStorage
        localStorage.setItem('writeToMe_session', JSON.stringify({
            isHost: appState.isHost,
            userName: appState.userName,
            userId: appState.userId,
            sessionId: appState.sessionId,
            connectionTime: appState.connectionTime
        }));
        
        connectionModal.style.display = 'none';
        updateUIAfterConnection();
        
        // Add connection message to chat
        await saveMessageToDB('System', `${appState.userName} has connected to the chat.`);
        
        // Setup real-time subscriptions
        setupRealtimeSubscription();
        setupImageSubscription();
        
        // If host, show admin panel
        if (appState.isHost) {
            adminPanel.style.display = 'block';
            refreshAdminInfo();
        }
    } else {
        alert("Failed to connect to the server. Please try again.");
    }
}

        // Generate a unique user ID
        function generateUserId() {
            return 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // Generate a session ID
        function generateSessionId() {
            return 'session_' + Date.now().toString(36);
        }

        // Get real IP using multiple free APIs
        async function getRealIP() {
    try {
        // Try the most reliable free API first
        const apis = [
            'https://api.ipify.org?format=json',
            'https://api64.ipify.org?format=json',
            'https://ipapi.co/json/'
        ];
        
        for (const api of apis) {
            try {
                // Add timeout to prevent hanging
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 3000);
                
                const response = await fetch(api, { 
                    signal: controller.signal 
                });
                
                clearTimeout(timeoutId);
                
                if (response.ok) {
                    const data = await response.json();
                    return data.ip || "Unknown";
                }
            } catch (e) {
                console.log(`API ${api} failed:`, e.message);
                continue;
            }
        }
        
        // If all APIs fail, check browser's RTCPeerConnection as fallback
        return await getIPFromWebRTC() || "Unable to detect";
    } catch (error) {
        console.error("Error getting IP:", error);
        return "Error detecting";
    }
}

// WebRTC fallback method (works in some browsers)
function getIPFromWebRTC() {
    return new Promise((resolve) => {
        const pc = new RTCPeerConnection({ iceServers: [] });
        pc.createDataChannel('');
        pc.createOffer().then(offer => pc.setLocalDescription(offer))
            .catch(() => resolve(null));
        
        pc.onicecandidate = (ice) => {
            if (ice && ice.candidate && ice.candidate.candidate) {
                const candidate = ice.candidate.candidate;
                const match = candidate.match(/([0-9]{1,3}(\.[0-9]{1,3}){3})/);
                if (match) {
                    resolve(match[1]);
                    pc.close();
                }
            }
        };
        
        setTimeout(() => {
            resolve(null);
            pc.close();
        }, 1000);
    });
}

        // Connect to Supabase and create/join session
        async function connectToSupabase() {
            try {
                // Check if session exists
                const { data: existingSessions, error: checkError } = await supabaseClient
                    .from('sessions')
                    .select('*')
                    .eq('is_active', true)
                    .limit(1);
                
                if (checkError) throw checkError;
                
                // If no active session, create one (Host only)
                if (existingSessions.length === 0) {
                    if (appState.isHost) {
                        // Host creates a new session
                        const { data: newSession, error: sessionError } = await supabaseClient
                            .from('sessions')
                            .insert([
                                {
                                    session_id: appState.sessionId,
                                    host_id: appState.userId,
                                    host_name: appState.userName,
                                    is_active: true,
                                    created_at: new Date().toISOString()
                                }
                            ])
                            .select()
                            .single();
                        
                        if (sessionError) throw sessionError;
                        return true;
                    } else {
                        // Guest cannot create session, only join
                        alert("No active session found. Please ask the Host to create a session first.");
                        return false;
                    }
                } else {
                    // Join existing session
                    const session = existingSessions[0];
                    
                    // Check if session already has 2 users
                    if (session.guest_id && session.guest_id !== appState.userId) {
                        alert("Session is full. Only 2 users can connect at a time.");
                        return false;
                    }
                    
                    // Update session with guest info
                    if (!appState.isHost) {
                        const { error: updateError } = await supabaseClient
                            .from('sessions')
                            .update({
                                guest_id: appState.userId,
                                guest_name: appState.userName,
                                guest_connected_at: new Date().toISOString()
                            })
                            .eq('session_id', session.session_id);
                        
                        if (updateError) throw updateError;
                    }
                    
                    appState.sessionId = session.session_id;
                    appState.otherUserName = appState.isHost ? (session.guest_name || "Guest") : session.host_name;
                    
                    return true;
                }
            } catch (error) {
                console.error("Error connecting to Supabase:", error);
                return false;
            }
        }

        // Reconnect to existing session
        async function reconnectToSession() {
            try {
                // Check if session still exists
                const { data: session, error } = await supabaseClient
                    .from('sessions')
                    .select('*')
                    .eq('session_id', appState.sessionId)
                    .eq('is_active', true)
                    .single();
                
                if (error || !session) return false;
                
                // Check if user is still in session
                if (appState.isHost) {
                    if (session.host_id !== appState.userId) return false;
                    appState.otherUserName = session.guest_name || "Guest";
                } else {
                    if (session.guest_id !== appState.userId) return false;
                    appState.otherUserName = session.host_name;
                }
                
                // Setup real-time subscriptions
                setupRealtimeSubscription();
                setupImageSubscription();
                
                return true;
            } catch (error) {
                console.error("Error reconnecting:", error);
                return false;
            }
        }


// Update UI after connection
function updateUIAfterConnection() {
    statusIndicator.classList.remove('offline');
    userRoleDisplay.textContent = `${appState.userName} (Connected)`;
    currentUserSpan.textContent = appState.userName;
    
    // Show logout button
    logoutBtn.style.display = 'flex';
    
    // Enable chat controls - MAKE SURE THESE ARE ENABLED
    messageInput.disabled = false;
    sendMessageBtn.disabled = false;
    messageInput.placeholder = "Type your message here...";
    messageInput.focus();
    
    // Enable image upload button
    uploadImageBtn.disabled = false;
    
    console.log("âœ… Chat input should be enabled now");
}

// Handle logout
async function handleLogout() {
    if (confirm("Are you sure you want to logout?")) {
        // Remove session from localStorage
        localStorage.removeItem('writeToMe_session');
        
        // Update session in database
        if (appState.isConnected && appState.sessionId) {
            try {
// Updated handleLogout() database section:
if (appState.isHost) {
    await supabaseClient
        .from('sessions')
        .update({ 
            is_active: false, 
            ended_at: new Date().toISOString()
            // KEEP guest info for history - don't null it
        })
        .eq('session_id', appState.sessionId);
} else {
    await supabaseClient
        .from('sessions')
        .update({ 
            guest_connected_at: null  // Just mark as disconnected
            // KEEP guest_id, guest_name, guest_ip for history
        })
        .eq('session_id', appState.sessionId);
}
            } catch (error) {
                console.error("Error updating session on logout:", error);
            }
        }
        
        // Remove real-time subscription
        if (appState.realtimeSubscription) {
            supabaseClient.removeChannel(appState.realtimeSubscription);
            appState.realtimeSubscription = null;
        }
        
        // Reset app state
        appState.isHost = false;
        appState.isConnected = false;
        appState.userName = "Guest";
        appState.userId = null;
        appState.sessionId = null;
        appState.messages = [];
        appState.currentImage = null;
        appState.otherUserName = "Host";
        appState.connectionTime = null;
        appState.adminVisible = false;
        
        // Reset UI
        statusIndicator.classList.add('offline');
        userRoleDisplay.textContent = "Disconnected";
        currentUserSpan.textContent = "Guest";
        logoutBtn.style.display = 'none';
        messageInput.disabled = true;
        sendMessageBtn.disabled = true;
        uploadImageBtn.disabled = true;
        imageUrlInput.disabled = true;
        downloadImageBtn.disabled = true;
        adminPanel.style.display = 'none';
        adminContent.classList.remove('show');
        
        // Reset chat and image (LOCAL ONLY - not database)
        chatMessages.innerHTML = '<div class="message received"><div class="message-sender">System</div><div>Welcome to WriteToMe! This is a secure chat room for two people only.</div><div class="message-time">Just now</div></div>';
        
        // Clear local image preview only
        appState.currentImage = null;
        imagePreview.style.display = 'none';
        imagePlaceholder.style.display = 'flex';
        downloadImageBtn.disabled = true;
        
        // Show connection modal
        connectionModal.style.display = 'flex';
        
        // Reset login form
        document.getElementById('userSelect').value = 'guest';
        document.getElementById('passwordInput').value = '';
        document.getElementById('passwordError').style.display = 'none';
        document.getElementById('passwordHint').textContent = '';
    }
}


        // Setup real-time subscription for messages
function setupRealtimeSubscription() {
    console.log('ðŸ”„ Setting up real-time subscription for session:', appState.sessionId);
    
    // Remove existing subscription if any
    if (appState.realtimeSubscription) {
        console.log('ðŸ—‘ï¸ Removing old subscription');
        supabaseClient.removeChannel(appState.realtimeSubscription);
    }
    
    // Create new subscription
    appState.realtimeSubscription = supabaseClient
        .channel('messages-channel-' + appState.sessionId)
        .on(
    'postgres_changes',
    {
        event: 'INSERT',
        schema: 'public',
        table: 'messages',
        filter: 'session_id=eq.' + appState.sessionId
    },
    (payload) => {
        console.log('ðŸ“¨ REAL-TIME EVENT RECEIVED:', payload);
        console.log('New message from:', payload.new.sender_name);
        console.log('Current user is:', appState.userName);
        
        // Don't show the user's own messages
        if (payload.new.sender_id !== appState.userId) {
            // Check if this message has been cleared by current user
            const clearedBy = payload.new.cleared_by || [];
            if (clearedBy.includes(appState.userId)) {
                console.log('â© Message was cleared by user, skipping');
                return; // Don't show cleared messages
            }
            
            console.log('âœ… Displaying message from other user');
            displayMessage({
                id: payload.new.id,
                sender: payload.new.sender_name,
                text: payload.new.message,
                time: new Date(payload.new.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                type: 'received'
            });
        } else {
            console.log('â© Skipping own message');
        }
    }
)
        .on('system', { event: 'channel_joined' }, () => {
            console.log('âœ… Successfully joined real-time channel');
        })
        .on('system', { event: 'channel_error' }, (error) => {
            console.error('âŒ Channel error:', error);
        })
        .subscribe((status) => {
            console.log('ðŸ“¡ Subscription status:', status);
        });
}
// Open image in modal
function openImageModal(imageSrc) {
    const modal = document.createElement('div');
    modal.className = 'image-modal';
    modal.innerHTML = `<img src="${imageSrc}" alt="Full size image">`;
    modal.onclick = () => modal.remove();
    document.body.appendChild(modal);
}

        // Load chat history from database
// Load chat history from database
async function loadChatHistory() {
    try {
        const { data: messages, error } = await supabaseClient
            .from('messages')
            .select('*')
            .eq('session_id', appState.sessionId)
            .order('created_at', { ascending: true });
        
        if (error) throw error;
        
        // Clear current messages
        chatMessages.innerHTML = '';
        appState.messages = [];
        
        // Display each message (filter out cleared ones for guests)
        messages.forEach(msg => {
            // For guests, check if they cleared this message
            if (!appState.isHost) {
                const clearedBy = msg.cleared_by || [];
                if (clearedBy.includes(appState.userId)) {
                    return; // Skip this message for guest
                }
            }
            
            const messageType = msg.sender_id === appState.userId ? 'sent' : 'received';
            displayMessage({
                id: msg.id,
                sender: msg.sender_name,
                text: msg.message,
                time: new Date(msg.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                type: messageType
            });
        });
    } catch (error) {
        console.error("Error loading chat history:", error);
    }
}


// Refresh messages manually
async function refreshMessages() {
    if (appState.isHistoricalView) {
        // If in historical view, reload that session
        await loadSessionIntoMainChat(appState.viewingSessionId, appState.viewingSessionName);
        return;
    }
    
    if (!appState.isConnected) {
        alert("You are not connected to a chat.");
        return;
    }
    
    console.log("ðŸ”„ Manually refreshing messages...");
    
    // Show loading indicator
    const loadingMsg = document.createElement('div');
    loadingMsg.className = 'message received';
    loadingMsg.innerHTML = `
        <div class="message-sender">System</div>
        <div><i class="fas fa-sync-alt fa-spin"></i> Refreshing messages...</div>
        <div class="message-time">Just now</div>
    `;
    chatMessages.appendChild(loadingMsg);
    
    try {
        // Reload chat history
        await loadChatHistory();
        
        // Remove loading message
        loadingMsg.remove();
        
        // Add success message
        addSystemMessage("Messages refreshed successfully.");
        
        console.log("âœ… Messages refreshed");
    } catch (error) {
        console.error("Error refreshing messages:", error);
        loadingMsg.remove();
        addSystemMessage("Error refreshing messages. Please try again.");
    }
}
        // Load current image from database
        async function loadCurrentImage() {
            try {
                const { data: session, error } = await supabaseClient
                    .from('sessions')
                    .select('current_image')
                    .eq('session_id', appState.sessionId)
                    .single();
                
                if (error) throw error;
                
                if (session.current_image) {
                    appState.currentImage = session.current_image;
                    displayImage(session.current_image);
                    downloadImageBtn.disabled = false;
                }
            } catch (error) {
                console.error("Error loading current image:", error);
            }
        }

        // Save message to database
        async function saveMessageToDB(senderName, messageText) {
            try {
                const { data, error } = await supabaseClient
                    .from('messages')
                    .insert([
                        {
                            session_id: appState.sessionId,
                            sender_id: appState.userId,
                            sender_name: senderName,
                            message: messageText,
                            created_at: new Date().toISOString()
                        }
                    ])
                    .select()
                    .single();
                
                if (error) throw error;
                return data;
            } catch (error) {
                console.error("Error saving message to database:", error);
                return null;
            }
        }

        // Send a chat message
async function sendMessage() {
    // Block sending in historical view
    if (appState.isHistoricalView) {
        alert("Cannot send messages in historical view. Return to live chat first.");
        return;
    }
    
    // âœ… ADDED THIS LINE:
    const messageText = messageInput.value.trim();
    
    if (!messageText) return;
    
    // Create message object
    const message = {
        id: Date.now(),
        sender: appState.userName,
        text: messageText,
        time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
        type: 'sent'
    };
    
    // Add to messages array
    appState.messages.push(message);
    
    // Display message immediately
    displayMessage(message);
    
    // Clear input
    messageInput.value = '';
    
    // Save to database
    await saveMessageToDB(appState.userName, messageText);
}

        // Display a message in the chat
        function displayMessage(message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${message.type}`;
            messageDiv.id = `msg-${message.id}`;
            
            messageDiv.innerHTML = `
                <div class="message-sender">${message.sender}</div>
                <div>${message.text}</div>
                <div class="message-time">${message.time}</div>
            `;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Add a system message
        function addSystemMessage(text) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message received';
            
            messageDiv.innerHTML = `
                <div class="message-sender">System</div>
                <div>${text}</div>
                <div class="message-time">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
            `;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // Also save to database
            saveMessageToDB('System', text);
        }

        // Handle typing indicator
        function handleTyping() {
            // Clear previous timeout
            if (appState.typingTimeout) {
                clearTimeout(appState.typingTimeout);
            }
        }



// Clear chat history - UPDATED WITH CORRECT SQL
async function clearChat() {
    if (confirm("Are you sure you want to clear all chat messages?")) {
        try {
            if (appState.isHost) {
                // Host clears - actually delete from database
                const { error } = await supabaseClient
                    .from('messages')
                    .delete()
                    .eq('session_id', appState.sessionId);
                
                if (error) throw error;
                
                // Clear local chat
                chatMessages.innerHTML = '';
                appState.messages = [];
                addSystemMessage("Chat history has been cleared for everyone.");
                
            } else {
                // Guest clears - CORRECTED SQL for array update
                
                // Method 1: Use Supabase's RPC (Recommended)
                // First, create this function in SQL Editor:
                
                /*
                CREATE OR REPLACE FUNCTION mark_messages_cleared(session_id_param TEXT, user_id_param TEXT)
                RETURNS void AS $$
                BEGIN
                    UPDATE messages 
                    SET cleared_by = array_append(COALESCE(cleared_by, '{}'::text[]), user_id_param)
                    WHERE session_id = session_id_param;
                END;
                $$ LANGUAGE plpgsql;
                */
                
                // Then call it:
                const { error: rpcError } = await supabaseClient
                    .rpc('mark_messages_cleared', {
                        session_id_param: appState.sessionId,
                        user_id_param: appState.userId
                    });
                
                if (rpcError) {
                    console.error("RPC error, trying direct update:", rpcError);
                    
                    // Fallback: Direct update (might not work for arrays)
                    const { data: messages } = await supabaseClient
                        .from('messages')
                        .select('id, cleared_by')
                        .eq('session_id', appState.sessionId);
                    
                    // Update each message individually
                    for (const msg of messages || []) {
                        const currentCleared = msg.cleared_by || [];
                        if (!currentCleared.includes(appState.userId)) {
                            await supabaseClient
                                .from('messages')
                                .update({ 
                                    cleared_by: [...currentCleared, appState.userId]
                                })
                                .eq('id', msg.id);
                        }
                    }
                }
                
                // IMMEDIATELY clear local chat
                chatMessages.innerHTML = '';
                appState.messages = [];
                
                // Add fresh system message
                const systemMsg = document.createElement('div');
                systemMsg.className = 'message received';
                systemMsg.innerHTML = `
                    <div class="message-sender">System</div>
                    <div>Chat history has been cleared from your view.</div>
                    <div class="message-time">Just now</div>
                `;
                chatMessages.appendChild(systemMsg);
                
                console.log("âœ… Guest chat cleared successfully");
            }
        } catch (error) {
            console.error("Error clearing chat:", error);
            alert("Error clearing chat. Please try again.");
        }
    }
}

// Handle image drop on chat area
function handleImageDrop(e) {
    e.preventDefault();
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        const file = files[0];
        if (file.type.startsWith('image/')) {
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(file);
            document.getElementById('fileInput').files = dataTransfer.files;
            handleFileSelect({ target: document.getElementById('fileInput') });
        }
    }
}

// Handle image file selection
async function handleFileSelect(e) {
    const file = e.target.files[0];
    if (!file || !file.type.startsWith('image/')) {
        alert("Please select an image file.");
        return;
    }
    
    // Check file size (max 5MB)
    if (file.size > 5 * 1024 * 1024) {
        alert("Image size should be less than 5MB.");
        return;
    }
    
    const reader = new FileReader();
    reader.onload = async function(e) {
        // Ask for optional caption
        const caption = prompt("Add a caption (optional):", "");
        
        // Send image in chat
        await sendImageInChat(e.target.result, caption);
        
        // Clear file input
        document.getElementById('fileInput').value = '';
    };
    reader.readAsDataURL(file);
}

// Send image in chat
async function sendImageInChat(imageData, caption = "") {
    // Generate a unique ID for this image message
    const imageId = 'img_' + Date.now();
    
    // Create image message HTML
    const imageMessage = `
        <div class="image-message-container">
            <img src="${imageData}" class="message-image" 
                 onclick="openImageModal('${imageData}')" 
                 alt="Shared image">
            ${caption ? `<div class="image-caption">${caption}</div>` : ''}
        </div>
    `;
    
    // Save as regular message to database
    await saveMessageToDB(appState.userName, imageMessage);
    
    // Display immediately in chat
    displayMessage({
        id: imageId,
        sender: appState.userName,
        text: imageMessage,
        time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
        type: 'sent'
    });
}

// Handle image URL sharing
async function shareImageFromUrl() {
    const url = prompt("Enter image URL:", "");
    if (!url) return;
    
    // Validate URL
    if (!url.match(/\.(jpeg|jpg|gif|png|webp|bmp)$/)) {
        alert("Please enter a valid image URL (jpg, png, gif, webp, bmp).");
        return;
    }
    
    const caption = prompt("Add a caption (optional):", "");
    await sendImageInChat(url, caption);
}



        // Toggle admin panel visibility
        function toggleAdminPanel() {
            appState.adminVisible = !appState.adminVisible;
            adminContent.classList.toggle('show', appState.adminVisible);
            
            const chevron = adminToggle.querySelector('i.fa-chevron-down');
            if (appState.adminVisible) {
                chevron.className = 'fas fa-chevron-up';
            } else {
                chevron.className = 'fas fa-chevron-down';
            }
        }

// Refresh admin information - Show ALL sessions
async function refreshAdminInfo() {
    if (!appState.isHost) return;
    
    try {
        // Get ALL sessions (not just current)
        const { data: allSessions, error } = await supabaseClient
            .from('sessions')
            .select('*')
            .order('created_at', { ascending: false })
            .limit(10); // Show last 10 sessions
        
        if (error) throw error;
        
        let sessionsHTML = '';
        
        // Process each session
        for (const session of allSessions) {
            const isActive = session.is_active;
            const isCurrent = session.session_id === appState.sessionId;
            
            // Calculate duration
            const sessionDuration = session.ended_at 
                ? Math.floor((new Date(session.ended_at) - new Date(session.created_at)) / 1000)
                : Math.floor((new Date() - new Date(session.created_at)) / 1000);
            
            const minutes = Math.floor(sessionDuration / 60);
            const seconds = sessionDuration % 60;
            
            // Get message count for this session
            const { count: messageCount } = await supabaseClient
                .from('messages')
                .select('*', { count: 'exact', head: true })
                .eq('session_id', session.session_id);
            
            sessionsHTML += `
                <div class="info-card ${isCurrent ? 'current-session' : ''}">
                    <h4>
                        <i class="fas fa-comments"></i> Session History
                        ${isActive ? '<span class="active-badge">ACTIVE NOW</span>' : ''}
                        ${isCurrent ? '<span class="current-badge">YOU ARE HERE</span>' : ''}
                    </h4>
                    <p><strong>Session ID:</strong> ${session.session_id.substring(0, 20)}...</p>
                    <p><strong>Host:</strong> ${session.host_name || 'Unknown'}</p>
                    <p><strong>Host IP:</strong> ${session.host_ip || 'Not recorded'}</p>
                    <p><strong>Guest:</strong> ${session.guest_name || 'No guest connected'}</p>
                    <p><strong>Guest IP:</strong> ${session.guest_ip || 'Not recorded'}</p>
                    <p><strong>Started:</strong> ${new Date(session.created_at).toLocaleString()}</p>
                    <p><strong>Status:</strong> ${isActive ? 'Active' : 'Ended'}</p>
                    <p><strong>Duration:</strong> ${minutes}m ${seconds}s</p>
                    <p><strong>Messages:</strong> ${messageCount || 0}</p>
<button class="btn btn-small" onclick="loadSessionIntoMainChat('${session.session_id}', 'Session from ${new Date(session.created_at).toLocaleDateString()}')">
    <i class="fas fa-history"></i> View in Chat
</button>
                    ${isCurrent ? '<button class="btn btn-small btn-danger" onclick="endCurrentSession()"><i class="fas fa-stop"></i> End Session</button>' : ''}
                </div>
            `;
        }
        
        adminInfo.innerHTML = sessionsHTML;
        
    } catch (error) {
        console.error("Error refreshing admin info:", error);
        adminInfo.innerHTML = `<div class="info-card"><p>Error loading sessions. ${error.message}</p></div>`;
    }
}

// Function to view chat history of any session
async function viewSessionHistory(sessionId) {
    try {
        const { data: messages, error } = await supabaseClient
            .from('messages')
            .select('*')
            .eq('session_id', sessionId)
            .order('created_at', { ascending: true });
        
        if (error) throw error;
        
        // Create modal for viewing history
        const modalHTML = `
            <div class="history-modal-overlay">
                <div class="history-modal">
                    <div class="history-modal-header">
                        <h3><i class="fas fa-history"></i> Chat History</h3>
                        <button class="close-modal" onclick="this.closest('.history-modal-overlay').remove()">&times;</button>
                    </div>
                    <div class="history-messages">
                        ${messages.length > 0 
                            ? messages.map(msg => `
                                <div class="history-message ${msg.sender_name === 'Host' ? 'sent' : 'received'}">
                                    <div class="history-sender">${msg.sender_name} <span class="history-time">${new Date(msg.created_at).toLocaleString()}</span></div>
                                    <div class="history-text">${msg.message}</div>
                                </div>
                            `).join('')
                            : '<p class="no-messages">No messages in this session.</p>'
                        }
                    </div>
                    <div class="history-modal-footer">
                        <button class="btn" onclick="this.closest('.history-modal-overlay').remove()">Close</button>
                    </div>
                </div>
            </div>
        `;
        
        // Add modal to page
        const modalDiv = document.createElement('div');
        modalDiv.innerHTML = modalHTML;
        document.body.appendChild(modalDiv.firstElementChild);
        
    } catch (error) {
        console.error("Error loading session history:", error);
        alert("Error loading chat history: " + error.message);
    }
}

// Function to end current session (Host only)
async function endCurrentSession() {
    if (confirm("Are you sure you want to end this session? The chat will be preserved in history.")) {
        try {
            await supabaseClient
                .from('sessions')
                .update({ 
                    is_active: false,
                    ended_at: new Date().toISOString()
                })
                .eq('session_id', appState.sessionId);
            
            alert("Session ended. Chat history saved.");
            refreshAdminInfo();
        } catch (error) {
            console.error("Error ending session:", error);
            alert("Error ending session: " + error.message);
        }
    }
}

        // Initialize the app when page loads
        document.addEventListener('DOMContentLoaded', initApp);

        // Test function to check chat input
function testChatInput() {
    console.log("=== CHAT INPUT TEST ===");
    console.log("1. Input element exists:", !!messageInput);
    console.log("2. Input disabled:", messageInput.disabled);
    console.log("3. Input placeholder:", messageInput.placeholder);
    console.log("4. App connected:", appState.isConnected);
    console.log("5. Is historical view:", appState.isHistoricalView);
    
    // Try to enable it
    messageInput.disabled = false;
    messageInput.focus();
    console.log("6. Input forced enabled");
}

// Run test after 2 seconds
setTimeout(testChatInput, 2000);

    </script>
</body>
</html>
